<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dagger & Die - Game</title>
    <!-- Google Analytics (GA4) - Replace G-XXXXXXXXXX with your Measurement ID -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 3rem;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Setup Screen */
        #setup-screen {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
        }

        .setup-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.5rem;
        }

        .player-count-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .player-count-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .player-count-btn:hover, .player-count-btn.selected {
            background: #48dbfb;
            transform: scale(1.1);
        }

        .player-setup {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .player-setup.visible {
            display: flex;
        }

        .player-input {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .player-input input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: #fff;
            font-size: 1rem;
        }

        .player-input input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .player-input.error input,
        .player-input.error-duplicate input {
            border: 2px solid #e74c3c;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.4);
        }

        .setup-error {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            color: #ff6b6b;
            font-size: 0.95rem;
        }

        .color-picker {
            display: flex;
            align-items: center;
        }

        .color-picker-wrap {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .color-picker-wrap:hover {
            transform: scale(1.12);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.8);
        }

        .color-swatch {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            pointer-events: none;
        }

        .player-color-input {
            position: absolute;
            width: 0;
            height: 0;
            opacity: 0;
            pointer-events: none;
        }

        /* Custom circular color picker modal */
        .color-picker-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .color-picker-modal-overlay.open {
            display: flex;
        }

        .color-picker-modal {
            background: linear-gradient(180deg, #1e2a3a 0%, #16213e 100%);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 100%;
        }

        .color-picker-modal h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: rgba(255,255,255,0.9);
        }

        .color-wheel-container {
            position: relative;
            width: 260px;
            height: 260px;
            margin: 0 auto 20px;
            touch-action: none;
        }

        .color-wheel-hue {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #ff0000, #ff8800, #ffff00, #88ff00, #00ff00, #00ff88, #00ffff, #0088ff, #0000ff, #8800ff, #ff00ff, #ff0088, #ff0000);
            padding: 12px;
        }

        .color-wheel-inner {
            position: absolute;
            inset: 12px;
            border-radius: 50%;
            background: #1e2a3a;
        }

        .color-wheel-sat {
            position: absolute;
            inset: 12px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--picker-gray, #808080) 0%, var(--picker-hue-color, #f00) 100%);
            cursor: crosshair;
        }

        .color-wheel-hue-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(0,0,0,0.5);
            pointer-events: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .color-wheel-sat-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(0,0,0,0.5);
            pointer-events: none;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .color-picker-lightness {
            margin-bottom: 20px;
        }

        .color-picker-lightness label {
            display: block;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 8px;
        }

        .color-picker-lightness input[type="range"] {
            width: 100%;
            height: 28px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        .color-picker-lightness input[type="range"]::-webkit-slider-runnable-track {
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(90deg, #000, #fff);
        }

        .color-picker-lightness input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            margin-top: -7px;
            cursor: pointer;
        }

        .color-picker-lightness input[type="range"]::-moz-range-track {
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(90deg, #000, #fff);
        }

        .color-picker-lightness input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid rgba(0,0,0,0.2);
            cursor: pointer;
        }

        .color-picker-done {
            display: block;
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(45deg, #48dbfb, #0abde3);
            color: #fff;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .color-picker-done:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,171,227,0.4);
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(238, 90, 36, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }

        .btn-danger {
            background: linear-gradient(45deg, #c0392b, #e74c3c);
            color: #fff;
        }

        .btn-center {
            display: block;
            margin: 0 auto;
        }

        /* Game Screen */
        #game-screen {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .game-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-gear-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            padding: 0;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.9);
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-gear-btn:hover {
            background: rgba(72, 219, 251, 0.3);
            color: #48dbfb;
        }

        .settings-gear-btn svg {
            width: 22px;
            height: 22px;
        }

        .settings-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .settings-modal-overlay.open {
            display: flex;
        }

        .settings-modal {
            background: linear-gradient(180deg, #1e2a3a 0%, #16213e 100%);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 380px;
            width: 100%;
        }

        .settings-modal h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            color: #feca57;
        }

        .settings-modal label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255,255,255,0.9);
            font-size: 0.95rem;
        }

        .settings-modal input[type="number"] {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 6px;
        }

        .settings-modal input[type="number"]:focus {
            outline: none;
            border-color: #48dbfb;
        }

        .settings-modal .setting-hint {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 20px;
        }

        .settings-modal .setting-readonly-hint {
            color: #feca57;
            margin-bottom: 16px;
        }

        .settings-modal .option-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .settings-modal .option-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #48dbfb;
        }

        .settings-modal .option-row label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .settings-modal .custom-hp-row {
            margin-left: 30px;
            margin-bottom: 20px;
        }

        .settings-modal input[type="number"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .settings-modal .btn {
            width: 100%;
            margin-top: 8px;
        }

        /* Player stats modal */
        .player-stats-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .player-stats-modal-overlay.open {
            display: flex;
        }

        .player-stats-modal {
            background: linear-gradient(180deg, #1e2a3a 0%, #16213e 100%);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 380px;
            width: 100%;
        }

        .player-stats-modal h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            color: #feca57;
            text-align: center;
        }

        .player-stats-modal h4 {
            font-size: 1rem;
            color: #48dbfb;
            margin-bottom: 10px;
        }

        .player-stats-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }

        .player-stats-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .player-stats-meta {
            flex: 1;
        }

        .player-stats-row {
            margin-bottom: 6px;
            color: rgba(255,255,255,0.95);
            font-size: 1rem;
        }

        .player-stats-section {
            margin-bottom: 24px;
        }

        .player-stats-section .setting-hint {
            margin-bottom: 12px;
        }

        .player-stats-modal .btn {
            width: 100%;
        }

        /* Critical hit onscreen reaction */
        .critical-reaction {
            position: fixed;
            inset: 0;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .critical-reaction.show {
            opacity: 1;
            animation: critical-pulse 0.3s ease-out;
        }
        .critical-reaction.hide {
            opacity: 0;
            transition: opacity 0.25s ease-out;
        }
        @keyframes critical-pulse {
            0% { transform: scale(0.85); }
            50% { transform: scale(1.06); }
            100% { transform: scale(1); }
        }
        .critical-reaction-inner {
            background: linear-gradient(135deg, rgba(254, 202, 87, 0.95) 0%, rgba(255, 107, 107, 0.9) 100%);
            color: #1a1a2e;
            font-size: clamp(2rem, 8vw, 4rem);
            font-weight: 900;
            letter-spacing: 0.15em;
            padding: 24px 48px;
            border-radius: 16px;
            box-shadow: 0 0 60px rgba(254, 202, 87, 0.6), 0 0 120px rgba(255, 107, 107, 0.3);
            text-transform: uppercase;
        }

        .turn-indicator {
            font-size: 1.5rem;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .current-player-name {
            font-weight: bold;
        }

        /* Players Panel */
        .players-panel {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            justify-content: center;
        }

        .player-card {
            position: relative;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            min-width: 150px;
            text-align: center;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .player-card.current {
            border-color: #feca57;
            box-shadow: 0 0 20px rgba(254, 202, 87, 0.4);
            transform: scale(1.05);
        }

        .player-card.eliminated {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .player-card.targetable {
            cursor: pointer;
        }

        .player-card.targetable:hover {
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.4);
        }

        .player-card-stats-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            padding: 0;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.9);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, color 0.2s;
        }

        .player-card-stats-btn:hover {
            background: rgba(72, 219, 251, 0.4);
            color: #48dbfb;
        }

        .player-card-stats-btn svg {
            width: 16px;
            height: 16px;
        }

        .player-card-dropped {
            animation: dropped-flash 0.6s ease-out;
        }

        @keyframes dropped-flash {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.8); transform: scale(1.05); }
            30% { box-shadow: 0 0 25px 8px rgba(255, 107, 107, 0.5); border-color: #ff6b6b; }
            100% { box-shadow: none; border-color: transparent; transform: scale(1); }
        }

        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .player-hp {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .hp-bar {
            width: 100%;
            height: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            overflow: hidden;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #2ecc71);
            transition: width 0.5s;
        }

        .player-turn-order {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Game Area */
        .game-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 900px) {
            .game-area {
                grid-template-columns: 1fr;
            }
        }

        /* Dice Section */
        .dice-section {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
        }

        .section-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .die {
            width: 65px;
            height: 65px;
            background: linear-gradient(145deg, #2d3436, #1e272e);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .die.rolling {
            animation: roll 0.1s infinite;
        }

        .die.odd {
            color: #ff6b6b;
            border-color: #ff6b6b;
        }

        .die.even {
            color: #48dbfb;
            border-color: #48dbfb;
        }

        @keyframes roll {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(10deg) scale(1.1); }
            50% { transform: rotate(0deg) scale(1); }
            75% { transform: rotate(-10deg) scale(1.1); }
        }

        .roll-btn {
            display: block;
            margin: 0 auto 20px;
            padding: 15px 50px;
        }

        .dice-results {
            text-align: center;
            margin-top: 15px;
        }

        .total-damage {
            font-size: 1.5rem;
            color: #feca57;
        }

        /* Target Section */
        .targets-section {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
        }

        .targets-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: nowrap;
        }

        .target-wrapper {
            position: relative;
            width: 180px;
        }

        .target-label {
            text-align: center;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.85rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .target-image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            overflow: hidden;
            /* Wood base color */
            background: radial-gradient(
                    circle at 45% 45%,
                    #d4a574 0%,
                    #c4956a 20%,
                    #b8895e 40%,
                    #a67c52 60%,
                    #8b6914 80%,
                    #6b4423 100%
                );
            border: 8px solid #3d2914;
            box-shadow:
                inset 0 0 20px rgba(0,0,0,0.3),
                inset 0 0 40px rgba(0,0,0,0.1),
                0 5px 15px rgba(0,0,0,0.5),
                0 2px 6px rgba(0,0,0,0.3);
        }

        .target-image {
            width: 90%;
            height: 90%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            object-fit: contain;
            object-position: center;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3));
            z-index: 2;
        }

        .target-overlay {
            position: absolute;
            top: 5%;
            left: 5%;
            width: 90%;
            height: 90%;
            pointer-events: none;
            z-index: 3;
        }

        .target-board-inline {
            position: absolute;
            top: 5%;
            left: 5%;
            width: 90%;
            height: 90%;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3));
        }

        .target-overlay.clickable {
            pointer-events: auto;
        }

        .target-overlay.clickable .highlight-zone.active {
            cursor: pointer;
        }

        .target-overlay.clickable .highlight-zone:not(.active) {
            cursor: default;
        }

        .highlight-zone {
            fill: none;
            stroke: transparent;
            stroke-width: 3;
            transition: all 0.3s;
            pointer-events: all;
        }

        .highlight-zone.active {
            fill: rgba(255, 215, 0, 0.35);
            stroke: #ffd700;
            stroke-width: 3;
            animation: pulse 1.5s infinite;
        }

        .highlight-zone.claimed {
            fill: rgba(46, 204, 113, 0.4);
            stroke: #2ecc71;
            stroke-width: 3;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Actions Section */
        .actions-section {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .attack-prompt {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #feca57;
        }

        .editable-hits-box:hover {
            background: rgba(46, 204, 113, 0.35) !important;
            border-color: #27ae60 !important;
        }

        .hit-info {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .hit-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .hit-badge.hit {
            background: #2ecc71;
        }

        .hit-badge.miss {
            background: #e74c3c;
        }

        /* Turn Order Screen */
        #turn-order-screen {
            display: none;
            text-align: center;
        }

        .turn-order-rolls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin: 30px auto;
        }

        .turn-order-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 10px;
        }

        .turn-order-player .roll-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #feca57;
        }

        /* Winner Screen */
        #winner-screen {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .winner-title {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px #feca57; }
            50% { text-shadow: 0 0 40px #feca57, 0 0 60px #ff6b6b; }
        }

        .winner-name {
            font-size: 2rem;
            margin-bottom: 40px;
        }

        /* Game Log */
        .game-log {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 10px;
            max-height: 120px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.85rem;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-damage {
            color: #ff6b6b;
        }

        .log-heal {
            color: #2ecc71;
        }

        .log-info {
            color: #48dbfb;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }

            .game-header {
                margin-bottom: 10px;
            }

            .turn-indicator {
                font-size: 1rem;
                padding: 8px 12px;
            }

            .players-panel {
                gap: 8px;
                margin-bottom: 15px;
            }

            .player-card {
                padding: 10px;
                min-width: 100px;
            }

            .player-avatar {
                width: 40px;
                height: 40px;
            }

            .player-hp {
                font-size: 1.1rem;
            }

            .player-turn-order {
                font-size: 0.7rem;
            }

            .game-area {
                gap: 15px;
            }

            .dice-section, .targets-section, .actions-section {
                padding: 15px;
                border-radius: 15px;
            }

            .section-title {
                font-size: 1rem;
                margin-bottom: 10px;
            }

            .die {
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }

            .dice-container {
                gap: 10px;
                margin-bottom: 10px;
            }

            .roll-btn {
                padding: 10px 30px;
                font-size: 1rem;
            }

            .target-wrapper {
                width: 140px;
            }

            .target-label {
                font-size: 0.75rem;
                margin-bottom: 3px;
            }

            .target-image-container {
                border-width: 6px;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .attack-prompt {
                font-size: 1rem;
            }

            .game-log {
                max-height: 100px;
                padding: 10px;
            }

            .log-entry {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 400px) {
            .target-wrapper {
                width: 120px;
            }

            .target-image-container {
                border-width: 5px;
            }

            .die {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }

            .player-card {
                min-width: 80px;
                padding: 8px;
            }

            .player-avatar {
                width: 30px;
                height: 30px;
            }

            .player-name {
                font-size: 0.85rem;
            }

            .player-hp {
                font-size: 0.95rem;
            }
        }

        /* Back to Home link */
        .back-link {
            display: inline-block;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            margin-bottom: 20px;
            font-size: 0.95rem;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: #48dbfb;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Home</a>
        <h1>Dagger & Die</h1>

        <!-- Setup Screen -->
        <div id="setup-screen">
            <h2 class="setup-title">Select Number of Players</h2>
            <div class="player-count-selector">
                <button class="player-count-btn" data-count="2">2</button>
                <button class="player-count-btn" data-count="3">3</button>
                <button class="player-count-btn" data-count="4">4</button>
                <button class="player-count-btn" data-count="5">5</button>
                <button class="player-count-btn" data-count="6">6</button>
            </div>
            <div class="player-setup" id="player-setup"></div>
            <div class="setup-error hidden" id="setup-error" role="alert"></div>
            <button class="btn btn-primary btn-center" id="start-game-btn" style="display:none;">Start Game</button>
        </div>

        <!-- Turn Order Screen -->
        <div id="turn-order-screen">
            <h2 class="setup-title">Rolling for Turn Order</h2>
            <p>Each player rolls a D20 to determine turn order. Highest goes first!</p>
            <div class="turn-order-rolls" id="turn-order-rolls"></div>
            <button class="btn btn-primary" id="roll-turn-order-btn">Roll for Turn Order</button>
            <button class="btn btn-primary hidden" id="begin-game-btn">Begin Game!</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen">
            <div class="game-header">
                <div class="turn-indicator">
                    Turn: <span class="current-player-name" id="current-player-name">-</span>
                </div>
                <div class="game-header-actions">
                    <button type="button" class="settings-gear-btn" id="settings-gear-btn" aria-label="Game settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>
                    <button class="btn btn-secondary" id="new-game-btn">New Game</button>
                </div>
            </div>

            <div class="players-panel" id="players-panel"></div>

            <div class="game-area">
                <div class="dice-section">
                    <h3 class="section-title">Your Dice</h3>
                    <div class="dice-container">
                        <div class="die" id="die1">-</div>
                        <div class="die" id="die2">-</div>
                        <div class="die" id="die3">-</div>
                    </div>
                    <button class="btn btn-primary roll-btn" id="roll-dice-btn">Roll Dice</button>
                    <div class="dice-results" id="dice-results"></div>
                </div>

                <div class="targets-section">
                    <h3 class="section-title">Target Boards</h3>
                    <div class="targets-container">
                        <div class="target-wrapper">
                            <div class="target-label">Odd Numbers (1-19)</div>
                            <div class="target-image-container">
                                <svg class="target-board-inline target-overlay" id="odd-overlay" viewBox="49 -377 300 341" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                                    <!-- Board artwork (from ODD.svg) -->
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 197.76089,-376.37521 c -0.44499,0.27385 -0.51346,3.04652 -0.61614,20.84626 l -0.10269,20.50397 0.99268,0.68462 0.99268,0.71882 1.26651,-0.88997 1.26653,-0.92424 -0.1027,-20.29856 c -0.10269,-22.28395 0.0342,-20.9832 -2.15651,-20.9832 -0.54768,0 -1.26651,0.17115 -1.54036,0.3423 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 188.34756,-371.85679 c -10.2691,6.09299 -30.12268,17.38899 -74.96439,42.65097 -54.186582,30.4992 -53.878507,30.32805 -53.775819,30.43073 0.06846,0.0685 4.004945,-0.95843 8.797188,-2.2592 l 8.72873,-2.3961 21.017411,-11.94638 c 17.93669,-10.20064 88.96458,-50.31856 94.37297,-53.33085 l 1.81421,-0.99266 v -2.84113 c 0,-1.54036 -0.0343,-2.80687 -0.0684,-2.77264 -0.0685,0 -2.70421,1.57459 -5.92185,3.45726 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 204.50427,-374.76639 c -0.13693,0.1027 -0.23962,1.33501 -0.23962,2.70421 v 2.49882 l 3.52573,1.95113 c 1.9169,1.09536 24.20083,13.6579 49.53126,27.96615 25.33044,14.30828 50.3528,28.4454 55.62426,31.42344 l 9.61871,5.40838 9.31064,2.90959 c 5.13454,1.60882 9.44757,2.94379 9.55026,2.94379 0.47923,0 -5.75069,-3.62841 -21.97584,-12.83635 -9.20798,-5.23724 -25.33043,-14.37675 -35.7707,-20.36706 -10.44025,-5.95607 -32.17648,-18.27897 -48.26474,-27.38422 -16.08824,-9.10529 -29.57497,-16.73864 -29.98574,-17.01249 -0.37655,-0.23962 -0.82154,-0.34231 -0.92422,-0.20539 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 193.4821,-332.66308 c -6.16145,1.43767 -139.248909,38.40641 -139.659672,38.81718 -0.581917,0.58189 0.308074,1.4719 2.293433,2.25918 l 1.916898,0.75307 10.577165,-2.87533 c 10.269096,-2.77267 74.861686,-20.50398 106.216666,-29.13 16.60169,-4.58687 16.67015,-4.6211 20.36704,-7.83874 1.33497,-1.16385 1.33497,-1.23231 0.71883,-1.71151 -0.68461,-0.51347 -1.16383,-0.58193 -2.43036,-0.27385 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 202.03967,-332.42346 c -0.58191,0.41074 -0.37652,0.65035 2.60152,2.87533 l 3.21764,2.43036 28.06885,7.70182 c 15.43789,4.24456 45.2867,12.49404 66.37257,18.3132 l 38.26951,10.57717 1.67729,-1.02692 c 0.9242,-0.54766 1.67728,-1.12959 1.67728,-1.23227 -0.0342,-0.51347 -28.06888,-9.34487 -39.87833,-12.59674 -11.56985,-3.18345 -73.6294,-20.2986 -87.83497,-24.23508 -6.50375,-1.81421 -12.22023,-3.28611 -12.66521,-3.28611 -0.47924,0 -1.16384,0.20539 -1.50615,0.47924 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 200.49931,-326.98085 c 0,1.60882 0.23962,2.60148 0.95845,4.1761 0.5477,1.12959 14.47942,26.39156 30.94421,56.13772 26.56273,47.95665 48.05937,86.94497 60.86149,110.39273 2.29343,4.24456 4.21033,7.73605 4.24457,7.77028 0.0342,0.0342 0.71884,0.17115 1.50612,0.30807 l 1.43766,0.23962 v -2.63571 -2.63575 l -21.12009,-38.06411 c -19.95625,-36.0103 -58.53383,-105.84013 -69.28215,-125.4541 l -4.92917,-9.00257 -2.29342,-1.67728 -2.32767,-1.71151 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 195.0567,-327.08354 c -1.84844,1.43766 -2.46459,2.22497 -3.90225,4.86069 -7.59913,14.13713 -25.53582,46.89553 -40.28909,73.52671 -33.10071,59.80036 -50.76355,91.87415 -51.721997,93.928 -0.718843,1.47189 -0.992683,2.60148 -0.992683,3.86802 v 1.81418 h 1.163826 c 0.958454,0 1.369224,-0.23959 2.019594,-1.09533 0.7873,-1.02693 18.99783,-33.88803 63.73685,-114.77425 9.37909,-16.94403 20.53817,-37.13989 24.8512,-44.91018 l 7.83874,-14.1029 v -2.39612 c 0,-1.33498 -0.10269,-2.43033 -0.23961,-2.43033 -0.17116,0 -1.26653,0.78728 -2.46458,1.71151 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 343.37664,-289.01944 -1.71152,1.06115 -3.86802,13.38405 c -2.12228,7.35951 -10.78254,37.37948 -19.23744,66.74909 l -15.3694,53.33085 v 3.32033 c 0,3.42303 0.23961,4.14187 1.43766,4.14187 1.16385,0 -0.27385,4.82647 22.83161,-75.47785 10.54295,-36.72911 13.45252,-47.10091 15.43787,-54.97388 1.335,-5.203 2.73844,-11.63831 2.73844,-12.32292 0,-0.47921 -0.41077,-0.34228 -2.2592,0.78731 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 50.810163,-261.84057 c -0.342305,41.93213 -1.232292,112.00157 -1.608827,125.41985 -0.17115,6.46954 -0.239612,11.8437 -0.17115,11.91216 0.06846,0.0685 1.19806,-0.44501 2.498814,-1.12962 l 2.36189,-1.30071 0.239612,-21.94167 c 0.581913,-56.24039 0.889987,-86.91074 0.958449,-102.04056 l 0.102689,-16.43053 -1.779974,-10.44025 c -0.958449,-5.7507 -1.916898,-10.81677 -2.088051,-11.26178 -0.171151,-0.51345 -0.376532,10.13218 -0.513452,27.21311 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 54.507034,-288.16367 c 0.102693,0.54766 0.889991,5.20299 1.711516,10.37177 0.85576,5.16879 1.882666,10.64563 2.259202,12.15177 0.376532,1.50612 4.997628,17.52591 10.234865,35.59951 10.200633,35.15454 21.565093,74.4167 22.694697,78.45588 l 0.684601,2.4988 h 1.677288 1.643054 v -2.19072 c 0,-1.30077 -0.41076,-3.79957 -0.992675,-6.05877 -0.547686,-2.15651 -8.14682,-28.71923 -16.909773,-59.01306 -22.386627,-77.36049 -20.640884,-71.43867 -21.496641,-72.12326 -1.095368,-0.92423 -1.677285,-0.78731 -1.506134,0.30808 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 347.24466,-283.26875 c -0.13692,0.47923 -1.16382,5.40838 -2.2592,10.95369 l -2.01959,10.09795 0.27384,22.93431 c 0.17115,12.63099 0.47924,39.87831 0.68462,60.58766 0.17115,20.70935 0.445,40.90522 0.54769,44.87594 l 0.20536,7.22259 1.84846,0.88997 c 1.0269,0.51347 2.01956,0.92424 2.19072,0.92424 0.23961,0 0.30808,-4.62112 0.17115,-13.62367 -0.17115,-11.53562 -1.09535,-109.19468 -1.30074,-136.81855 -0.0342,-4.89496 -0.17115,-8.52336 -0.34231,-8.04413 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 104.82559,-146.0052 -6.503758,0.17116 2.053818,0.99266 c 1.12961,0.51346 3.18343,1.40346 4.55264,1.95116 l 2.49881,0.99266 h 92.11377 92.14801 l 4.27878,-1.60882 c 4.17611,-1.57462 4.24454,-1.64308 3.11495,-1.9169 -0.65038,-0.13692 -4.89492,-0.41076 -9.41332,-0.58192 -8.59183,-0.30805 -173.51346,-0.34228 -184.8437,0 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 83.773955,-140.11759 c -4.621096,2.63572 -13.931743,7.80452 -20.709345,11.50139 -6.777598,3.66263 -12.665214,6.98297 -13.110207,7.42797 -0.753067,0.68462 -0.787298,0.85577 -0.410762,2.19074 0.205381,0.78731 0.581913,1.50613 0.821525,1.60882 0.273843,0.1027 1.471904,-0.27385 2.738426,-0.85574 2.259202,-1.0269 14.855953,-7.80451 25.227741,-13.58944 3.114955,-1.71153 8.215275,-4.48417 11.36446,-6.12722 5.613776,-2.90959 5.716464,-2.97806 5.716464,-4.07341 0,-1.19805 -0.547681,-1.84844 -2.156509,-2.53306 -0.513455,-0.23962 -0.992679,-0.41077 -1.02691,-0.41077 -0.03423,0.0342 -3.833794,2.19077 -8.454883,4.86072 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 303.9091,-143.36946 c -1.91689,1.5746 -2.08804,1.43767 21.35972,14.44518 11.98059,6.64069 21.97584,11.98062 22.24969,11.87793 0.71885,-0.27385 1.60882,-2.19073 1.4719,-3.21765 -0.1027,-0.78731 -0.75305,-1.26653 -5.06608,-3.59418 -2.73844,-1.47192 -10.88523,-5.9903 -18.14208,-9.99526 -15.78018,-8.76293 -17.66285,-9.68717 -19.57974,-9.96101 -1.16382,-0.17117 -1.64305,-0.0685 -2.29341,0.44499 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 98.15068,-141.41833 c 0,0.71882 0.376537,1.60882 0.992683,2.4646 0.54769,0.71881 9.516027,10.2006 19.922047,21.01737 10.44023,10.85102 27.28155,28.548103 37.44796,39.364874 10.1664,10.81679 23.51622,24.74854 29.67768,30.978431 l 11.1933,11.295996 0.0342,-2.669948 v -2.669967 l -8.11257,-8.626029 c -4.44995,-4.758021 -16.67017,-17.628614 -27.11041,-28.650798 -28.75347,-30.293809 -35.97606,-37.927179 -46.48476,-49.120479 -5.27148,-5.64799 -10.13218,-10.7483 -10.74833,-11.36446 -0.68461,-0.65038 -2.29343,-1.50616 -3.97071,-2.12228 l -2.841121,-1.0269 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 297.67918,-141.21297 c -1.26654,0.47923 -2.84113,1.19808 -3.52571,1.57462 -0.71885,0.37653 -6.50378,6.33259 -14.13714,14.51363 -12.22023,13.14446 -40.25485,42.616743 -67.46794,70.856771 l -12.35715,12.83635 v 3.080747 l -0.0342,3.080719 2.9438,-2.909595 c 6.50377,-6.401044 26.97349,-27.555379 37.61912,-38.851375 6.19569,-6.606458 18.58707,-19.682436 27.5554,-29.095787 30.08844,-31.62879 32.17649,-33.888 32.17649,-35.08608 0,-0.99266 -0.34228,-0.99266 -2.77264,0 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 55.568176,-116.32751 c -1.711517,0.85577 -2.259203,1.26651 -1.882667,1.4719 5.168775,2.84113 133.566681,74.690525 136.887011,76.607427 l 1.54037,0.889995 -2.12228,-2.361894 c -1.1296,-1.334969 -3.83379,-4.107644 -5.99031,-6.195689 -3.08073,-3.012262 -4.48416,-4.107614 -6.94875,-5.442622 -5.33993,-2.875323 -41.79521,-23.139682 -68.63177,-38.166784 -24.098146,-13.520983 -50.318564,-28.103113 -50.455483,-28.068873 0,0.0343 -1.095372,0.58192 -2.396121,1.26654 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 338.96091,-117.11482 c -0.65035,0.44501 -78.49008,44.122867 -107.14085,60.108429 l -13.69214,7.667597 -5.06608,4.963407 c -5.7507,5.647998 -6.67491,6.811814 -4.31301,5.442613 3.76533,-2.190742 60.07419,-33.716874 109.94775,-61.546096 l 25.94659,-14.47944 -2.43036,-1.30073 c -1.33499,-0.75309 -2.46459,-1.33501 -2.49881,-1.33501 -0.0685,0 -0.37655,0.20538 -0.75309,0.47923 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 62.46342,-300.16683 c 0.482784,-0.29364 12.99128,-7.35796 27.796656,-15.69848 60.520594,-34.09391 84.453444,-47.67809 97.580894,-55.3865 l 5.99823,-3.52214 0.0887,2.38689 c 0.0753,2.02559 0.009,2.4458 -0.43889,2.7761 -0.29018,0.21407 -10.46856,5.98769 -22.61863,12.83026 -12.15006,6.84258 -36.64038,20.68484 -54.42293,30.76059 -17.782541,10.07575 -34.043586,19.27045 -36.135649,20.43267 -3.650189,2.0278 -4.093165,2.19074 -10.972366,4.03599 -3.942736,1.05758 -7.30028,1.92189 -7.461208,1.9207 -0.160928,-0.001 0.102409,-0.24243 0.585193,-0.53608 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 55.852251,-292.09638 c -1.030769,-0.52302 -1.874126,-1.08261 -1.874126,-1.24354 0,-0.16093 4.213388,-1.49839 9.363084,-2.97213 22.616067,-6.47229 118.026011,-32.9328 128.973061,-35.76873 1.70838,-0.44257 2.47091,-0.51732 3.04618,-0.2986 l 0.76736,0.29175 -0.99801,1.03195 c -2.39917,2.48077 -5.12348,3.68971 -13.87225,6.15591 -4.97922,1.4036 -75.52988,20.77959 -105.234523,28.90155 -9.761513,2.66902 -17.871605,4.85277 -18.022428,4.85277 -0.150822,0 -1.117579,-0.42792 -2.148348,-0.95093 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 198.14821,-334.562 -0.95772,-0.6192 0.16381,-18.72617 c 0.0901,-10.29939 0.23392,-19.53615 0.31959,-20.52613 0.15522,-1.79355 0.1595,-1.80065 1.20129,-1.99609 1.8093,-0.33943 1.95911,0.0483 2.17759,5.63504 0.10519,2.6899 0.20394,11.6935 0.21945,20.008 l 0.0282,15.11728 -1.09724,0.86324 -1.09724,0.86324 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 330.33541,-300.64296 -7.7538,-2.44546 -44.47465,-25.1241 c -24.46106,-13.81825 -51.02036,-28.80756 -59.02068,-33.30958 l -14.54603,-8.18548 -0.0106,-2.44522 c -0.009,-2.15724 0.0464,-2.42335 0.47346,-2.25946 0.26625,0.10217 3.92004,2.14047 8.11955,4.52955 4.1995,2.38909 20.86812,11.84696 37.04139,21.0175 56.58984,32.08746 88.6567,50.38153 88.6567,50.57845 0,0.27762 -1.12292,-0.0342 -8.4853,-2.3562 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 335.45584,-292.17088 c -3.76534,-1.07089 -98.6484,-27.27286 -120.01656,-33.14259 l -7.36697,-2.02367 -2.62459,-1.95419 c -2.84195,-2.11602 -3.46594,-2.71873 -3.14599,-3.03868 0.44259,-0.44258 2.56461,-0.0918 7.48397,1.23716 12.61251,3.40725 97.69506,26.92496 101.23835,27.98335 11.84429,3.53792 29.52735,9.14896 31.66405,10.04737 l 0.86158,0.36227 -1.43917,0.9235 c -0.79153,0.50793 -1.62512,0.90781 -1.85243,0.88862 -0.2273,-0.0192 -2.38831,-0.59661 -4.80224,-1.28314 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 298.29611,-148.5566 c -0.42602,-0.0863 -2.09333,-2.88089 -6.12974,-10.27418 -9.02527,-16.53113 -20.99806,-38.25465 -53.41165,-96.9105 -37.71104,-68.24216 -37.08433,-67.09691 -37.62922,-68.76284 -0.24545,-0.7504 -0.40525,-1.9732 -0.35513,-2.71733 l 0.0911,-1.35297 2.08532,1.5801 c 1.80362,1.36665 2.2731,1.92831 3.47548,4.15782 4.35017,8.06631 47.6233,86.43204 77.86658,141.01296 l 15.9091,28.7116 v 2.37676 c 0,2.58399 0.015,2.56675 -1.90188,2.17858 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 98.385927,-151.06492 c 0.232413,-2.64438 -2.297287,2.07245 38.249993,-71.32037 31.64972,-57.28776 39.86799,-72.23974 50.90077,-92.60676 2.61523,-4.82784 5.07226,-9.19967 5.46006,-9.71517 0.64878,-0.86242 3.94194,-3.59797 4.33138,-3.59797 0.0927,0 0.16852,0.95204 0.16852,2.11564 v 2.11564 l -5.52016,9.95396 c -3.03609,5.47468 -21.18987,38.26267 -40.34173,72.86219 -51.863467,93.69591 -50.12491,90.5905 -51.18235,91.42228 -0.41903,0.3296 -1.09157,0.59928 -1.494538,0.59928 -0.720823,0 -0.730073,-0.0296 -0.571945,-1.82872 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 304.00174,-147.47394 c -0.3359,-0.21196 -0.46205,-1.03167 -0.53757,-3.49296 l -0.0987,-3.21601 19.08157,-66.21364 c 10.49489,-36.41751 19.18663,-66.49255 19.31498,-66.83341 0.19132,-0.50801 2.85047,-2.4525 3.35389,-2.4525 0.8664,0 -3.02829,15.0219 -12.44116,47.98581 -18.24074,63.87916 -26.38123,91.72058 -27.39785,93.70399 -0.44771,0.87347 -0.60902,0.93909 -1.27519,0.51872 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 346.53466,-125.97846 -1.50281,-0.68721 -0.17444,-3.16572 c -0.19452,-3.53052 -0.35911,-15.23434 -0.77694,-55.24786 -0.15629,-14.96631 -0.41461,-38.46912 -0.57402,-52.22846 l -0.28985,-25.01699 2.01565,-9.80198 2.01567,-9.80198 0.0316,2.77967 c 0.0175,1.52881 0.22442,23.51743 0.46006,48.86359 0.23564,25.34616 0.57404,59.21359 0.75203,75.26095 0.17798,16.04736 0.2396,29.31295 0.13692,29.47909 -0.24313,0.39336 -0.32242,0.37696 -2.09389,-0.4331 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 103.48,-143.80003 c -2.06286,-0.86625 -3.808031,-1.63237 -3.878148,-1.70249 -0.361887,-0.36189 29.449688,-0.51457 99.478818,-0.50949 72.11852,0.005 97.73556,0.21334 99.34045,0.80702 0.53534,0.19804 0.016,0.48037 -2.9719,1.61554 l -3.62061,1.37557 -92.29897,-0.006 -92.29897,-0.006 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 200.43337,-38.571783 -0.0107,-2.716662 14.84926,-15.432008 c 24.81296,-25.786715 45.69132,-47.704027 64.01069,-67.195977 14.39488,-15.31626 14.45328,-15.37177 17.50666,-16.63822 5.64971,-2.34335 5.18122,-1.61471 -7.86935,12.2391 -2.42556,2.57484 -11.90749,12.58525 -21.07095,22.24536 -9.16346,9.660094 -21.26923,22.428092 -26.90172,28.373306 -11.87365,12.532968 -24.06405,25.173146 -33.71098,34.954818 l -6.79211,6.886971 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 338.96872,-121.76392 c -9.88254,-5.32631 -25.99897,-14.27074 -30.43174,-16.88927 -5.41369,-3.19798 -5.89958,-3.72794 -4.21611,-4.5985 1.34017,-0.69303 2.74538,-0.33246 6.80953,1.7473 5.306,2.71527 35.58621,19.44641 36.71681,20.28764 0.84791,0.63091 0.95586,0.85041 0.80036,1.62777 -0.19201,0.96014 -0.92414,2.24777 -1.27516,2.24274 -0.117,-0.002 -3.89866,-1.98964 -8.40369,-4.41768 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 208.90031,-39.732008 c -0.004,-0.120676 2.13543,-2.294784 4.75469,-4.831291 l 4.7623,-4.611846 43.30426,-24.260519 c 23.81735,-13.343281 51.13588,-28.667046 60.70787,-34.052796 l 17.40357,-9.79227 1.97551,1.06601 c 1.08654,0.5863 1.94504,1.16316 1.90778,1.28192 -0.0373,0.11875 -18.23796,10.36716 -40.44604,22.774267 -50.72295,28.337642 -70.04582,39.148914 -83.44527,46.688163 -5.82382,3.276811 -10.66263,5.957808 -10.75291,5.957808 -0.0903,0 -0.16758,-0.09874 -0.17176,-0.219446 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 89.276313,-159.84595 c -1.667569,-5.83192 -7.171905,-24.8895 -12.23186,-42.35019 -15.112389,-52.14924 -18.214002,-63.01714 -18.802557,-65.88325 -0.883403,-4.30196 -3.572119,-20.49038 -3.427279,-20.63522 0.245134,-0.24514 1.31562,0.60831 1.630872,1.30022 0.587466,1.28934 12.487191,42.15041 28.950349,99.40917 9.590011,33.354 9.418058,32.70899 9.613821,36.06251 l 0.157996,2.70651 -1.4297,-0.003 -1.429703,-0.003 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 49.265064,-129.41279 c 0.354638,-8.52261 1.145447,-66.31708 1.638487,-119.74508 0.164842,-17.863 0.386303,-33.59737 0.492136,-34.96526 0.226811,-2.93155 0.01564,-3.7783 2.132345,8.55019 l 1.49312,8.69648 -0.293374,32.26701 c -0.161356,17.74686 -0.433637,48.00138 -0.605069,67.23228 -0.171432,19.23089 -0.385487,36.18791 -0.475678,37.68225 l -0.163984,2.71699 -2.012779,1.01361 c -1.107028,0.55749 -2.097851,1.01362 -2.201828,1.01362 -0.103977,0 -0.105497,-2.00794 -0.0034,-4.46209 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 50.090998,-118.44043 c -0.65134,-1.7431 -0.648428,-1.85649 0.0643,-2.50365 0.388729,-0.35297 4.041258,-2.47812 8.116731,-4.72257 15.964504,-8.79197 20.823124,-11.49453 27.238926,-15.15138 7.095162,-4.04408 7.220651,-4.08464 8.79793,-2.84396 0.862954,0.6788 1.057632,2.02302 0.375028,2.58953 -0.222199,0.18441 -4.139334,2.3498 -8.704741,4.81197 -4.565409,2.46217 -11.724119,6.36224 -15.908247,8.66681 -9.080396,5.0014 -18.664348,9.95789 -19.254727,9.95789 -0.233493,0 -0.559834,-0.36209 -0.725201,-0.80464 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 189.38705,-44.751497 c -9.85444,-9.996885 -14.60137,-14.942556 -34.01067,-35.434561 -8.76309,-9.251923 -23.97444,-25.248442 -33.803,-35.547852 -23.427501,-24.54979 -22.351581,-23.39271 -22.840814,-24.56362 -0.762799,-1.82563 -0.641472,-1.95152 1.256342,-1.30356 3.686652,1.2587 4.003992,1.54439 16.869802,15.18741 6.75334,7.1613 23.94696,25.33155 38.20804,40.378293 14.26109,15.046775 29.57606,31.228136 34.03328,35.958595 l 8.10403,8.600836 v 2.298383 c 0,1.264126 -0.0329,2.277983 -0.0731,2.253033 -0.0402,-0.02487 -3.52497,-3.547084 -7.74386,-7.826957 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="M 153.14063,-59.503129 C 133.00941,-70.796842 102.50049,-87.87141 85.343035,-97.446628 68.185581,-107.02185 54.142434,-114.94607 54.136043,-115.056 c -0.0064,-0.10993 0.86403,-0.66485 1.934268,-1.23314 l 1.945888,-1.03328 14.366361,7.99185 c 7.901499,4.39549 27.335695,15.23452 43.1871,24.086711 15.85141,8.852191 35.53584,19.816471 43.74316,24.365055 19.60085,10.862945 19.39622,10.746052 20.92065,11.952023 2.87154,2.27166 10.46525,10.038556 9.75607,9.978549 -0.13568,-0.01138 -16.71769,-9.261184 -36.84891,-20.554897 z"/>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="149" y="-364" transform="scale(1.0849228,0.92172456)"><tspan x="149" y="-364">17</tspan></text>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="189.18443" y="-363.52252" transform="scale(1.0849228,0.92172456)"><tspan x="189.18443" y="-363.52252">11</tspan></text>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="54" y="-166" transform="scale(1.0849228,0.92172456)"><tspan x="54" y="-166">15</tspan></text>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="68.467308" y="-121.53728" transform="scale(1.0849228,0.92172456)"><tspan x="68.467308" y="-121.53728">13</tspan></text>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="267.46765" y="-119.95848" transform="scale(1.0849228,0.92172456)"><tspan x="267.46765" y="-119.95848">19</tspan></text>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="293" y="-160" transform="scale(1.0849228,0.92172456)"><tspan x="293" y="-160">9</tspan></text>
                                    <text xml:space="preserve" style="font-size:115.18px;fill:#000000" x="146.21255" y="-190.30255" transform="scale(1.0858342,0.92095091)"><tspan x="146.21255" y="-190.30255">1</tspan></text>
                                    <text xml:space="preserve" style="font-size:94.9442px;fill:#000000" x="235.65741" y="-248.44785" transform="scale(1.0977534,0.9109514)"><tspan x="235.65741" y="-248.44785">7</tspan></text>
                                    <text xml:space="preserve" style="font-size:94.9442px;fill:#000000" x="70" y="-246" transform="scale(1.0977534,0.9109514)"><tspan x="70" y="-246">3</tspan></text>
                                    <text xml:space="preserve" style="font-size:94.9442px;fill:#000000" x="151" y="-82" transform="scale(1.0977534,0.9109514)"><tspan x="151" y="-82">5</tspan></text>
                                    <!-- Highlight zones: circles around each number -->
                                    <g class="highlight-zones">
                                        <circle class="highlight-zone" data-number="1" cx="146" cy="-190" r="52"/>
                                        <circle class="highlight-zone" data-number="3" cx="70" cy="-246" r="40"/>
                                        <circle class="highlight-zone" data-number="5" cx="151" cy="-82" r="40"/>
                                        <circle class="highlight-zone" data-number="7" cx="236" cy="-248" r="40"/>
                                        <circle class="highlight-zone" data-number="9" cx="293" cy="-160" r="22"/>
                                        <circle class="highlight-zone" data-number="11" cx="189" cy="-364" r="22"/>
                                        <circle class="highlight-zone" data-number="13" cx="68" cy="-122" r="22"/>
                                        <circle class="highlight-zone" data-number="15" cx="54" cy="-166" r="22"/>
                                        <circle class="highlight-zone" data-number="17" cx="149" cy="-364" r="22"/>
                                        <circle class="highlight-zone" data-number="19" cx="267" cy="-120" r="22"/>
                                    </g>
                                </svg>
                            </div>
                        </div>
                        <div class="target-wrapper">
                            <div class="target-label">Even Numbers (2-20)</div>
                            <div class="target-image-container">
                                <svg class="target-board-inline target-overlay" id="even-overlay" viewBox="49 -377 300 341" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                                    <!-- Board artwork (from EVEN.svg) -->
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 197.76089,-376.37521 c -0.44499,0.27385 -0.51346,3.04652 -0.61614,20.84626 l -0.10269,20.50397 0.99268,0.68462 0.99268,0.71882 1.26651,-0.88997 1.26653,-0.92424 -0.1027,-20.29856 c -0.10269,-22.28395 0.0342,-20.9832 -2.15651,-20.9832 -0.54768,0 -1.26651,0.17115 -1.54036,0.3423 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 188.34756,-371.85679 c -10.2691,6.09299 -30.12268,17.38899 -74.96439,42.65097 -54.186582,30.4992 -53.878507,30.32805 -53.775819,30.43073 0.06846,0.0685 4.004945,-0.95843 8.797188,-2.2592 l 8.72873,-2.3961 21.017411,-11.94638 c 17.93669,-10.20064 88.96458,-50.31856 94.37297,-53.33085 l 1.81421,-0.99266 v -2.84113 c 0,-1.54036 -0.0343,-2.80687 -0.0684,-2.77264 -0.0685,0 -2.70421,1.57459 -5.92185,3.45726 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 204.50427,-374.76639 c -0.13693,0.1027 -0.23962,1.33501 -0.23962,2.70421 v 2.49882 l 3.52573,1.95113 c 1.9169,1.09536 24.20083,13.6579 49.53126,27.96615 25.33044,14.30828 50.3528,28.4454 55.62426,31.42344 l 9.61871,5.40838 9.31064,2.90959 c 5.13454,1.60882 9.44757,2.94379 9.55026,2.94379 0.47923,0 -5.75069,-3.62841 -21.97584,-12.83635 -9.20798,-5.23724 -25.33043,-14.37675 -35.7707,-20.36706 -10.44025,-5.95607 -32.17648,-18.27897 -48.26474,-27.38422 -16.08824,-9.10529 -29.57497,-16.73864 -29.98574,-17.01249 -0.37655,-0.23962 -0.82154,-0.34231 -0.92422,-0.20539 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 193.4821,-332.66308 c -6.16145,1.43767 -139.248909,38.40641 -139.659672,38.81718 -0.581917,0.58189 0.308074,1.4719 2.293433,2.25918 l 1.916898,0.75307 10.577165,-2.87533 c 10.269096,-2.77267 74.861686,-20.50398 106.216666,-29.13 16.60169,-4.58687 16.67015,-4.6211 20.36704,-7.83874 1.33497,-1.16385 1.33497,-1.23231 0.71883,-1.71151 -0.68461,-0.51347 -1.16383,-0.58193 -2.43036,-0.27385 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 202.03967,-332.42346 c -0.58191,0.41074 -0.37652,0.65035 2.60152,2.87533 l 3.21764,2.43036 28.06885,7.70182 c 15.43789,4.24456 45.2867,12.49404 66.37257,18.3132 l 38.26951,10.57717 1.67729,-1.02692 c 0.9242,-0.54766 1.67728,-1.12959 1.67728,-1.23227 -0.0342,-0.51347 -28.06888,-9.34487 -39.87833,-12.59674 -11.56985,-3.18345 -73.6294,-20.2986 -87.83497,-24.23508 -6.50375,-1.81421 -12.22023,-3.28611 -12.66521,-3.28611 -0.47924,0 -1.16384,0.20539 -1.50615,0.47924 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 200.49931,-326.98085 c 0,1.60882 0.23962,2.60148 0.95845,4.1761 0.5477,1.12959 14.47942,26.39156 30.94421,56.13772 26.56273,47.95665 48.05937,86.94497 60.86149,110.39273 2.29343,4.24456 4.21033,7.73605 4.24457,7.77028 0.0342,0.0342 0.71884,0.17115 1.50612,0.30807 l 1.43766,0.23962 v -2.63571 -2.63575 l -21.12009,-38.06411 c -19.95625,-36.0103 -58.53383,-105.84013 -69.28215,-125.4541 l -4.92917,-9.00257 -2.29342,-1.67728 -2.32767,-1.71151 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 195.0567,-327.08354 c -1.84844,1.43766 -2.46459,2.22497 -3.90225,4.86069 -7.59913,14.13713 -25.53582,46.89553 -40.28909,73.52671 -33.10071,59.80036 -50.76355,91.87415 -51.721997,93.928 -0.718843,1.47189 -0.992683,2.60148 -0.992683,3.86802 v 1.81418 h 1.163826 c 0.958454,0 1.369224,-0.23959 2.019594,-1.09533 0.7873,-1.02693 18.99783,-33.88803 63.73685,-114.77425 9.37909,-16.94403 20.53817,-37.13989 24.8512,-44.91018 l 7.83874,-14.1029 v -2.39612 c 0,-1.33498 -0.10269,-2.43033 -0.23961,-2.43033 -0.17116,0 -1.26653,0.78728 -2.46458,1.71151 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 343.37664,-289.01944 -1.71152,1.06115 -3.86802,13.38405 c -2.12228,7.35951 -10.78254,37.37948 -19.23744,66.74909 l -15.3694,53.33085 v 3.32033 c 0,3.42303 0.23961,4.14187 1.43766,4.14187 1.16385,0 -0.27385,4.82647 22.83161,-75.47785 10.54295,-36.72911 13.45252,-47.10091 15.43787,-54.97388 1.335,-5.203 2.73844,-11.63831 2.73844,-12.32292 0,-0.47921 -0.41077,-0.34228 -2.2592,0.78731 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 50.810163,-261.84057 c -0.342305,41.93213 -1.232292,112.00157 -1.608827,125.41985 -0.17115,6.46954 -0.239612,11.8437 -0.17115,11.91216 0.06846,0.0685 1.19806,-0.44501 2.498814,-1.12962 l 2.36189,-1.30071 0.239612,-21.94167 c 0.581913,-56.24039 0.889987,-86.91074 0.958449,-102.04056 l 0.102689,-16.43053 -1.779974,-10.44025 c -0.958449,-5.7507 -1.916898,-10.81677 -2.088051,-11.26178 -0.171151,-0.51345 -0.376532,10.13218 -0.513452,27.21311 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 54.507034,-288.16367 c 0.102693,0.54766 0.889991,5.20299 1.711516,10.37177 0.85576,5.16879 1.882666,10.64563 2.259202,12.15177 0.376532,1.50612 4.997628,17.52591 10.234865,35.59951 10.200633,35.15454 21.565093,74.4167 22.694697,78.45588 l 0.684601,2.4988 h 1.677288 1.643054 v -2.19072 c 0,-1.30077 -0.41076,-3.79957 -0.992675,-6.05877 -0.547686,-2.15651 -8.14682,-28.71923 -16.909773,-59.01306 -22.386627,-77.36049 -20.640884,-71.43867 -21.496641,-72.12326 -1.095368,-0.92423 -1.677285,-0.78731 -1.506134,0.30808 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 347.24466,-283.26875 c -0.13692,0.47923 -1.16382,5.40838 -2.2592,10.95369 l -2.01959,10.09795 0.27384,22.93431 c 0.17115,12.63099 0.47924,39.87831 0.68462,60.58766 0.17115,20.70935 0.445,40.90522 0.54769,44.87594 l 0.20536,7.22259 1.84846,0.88997 c 1.0269,0.51347 2.01956,0.92424 2.19072,0.92424 0.23961,0 0.30808,-4.62112 0.17115,-13.62367 -0.17115,-11.53562 -1.09535,-109.19468 -1.30074,-136.81855 -0.0342,-4.89496 -0.17115,-8.52336 -0.34231,-8.04413 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 104.82559,-146.0052 -6.503758,0.17116 2.053818,0.99266 c 1.12961,0.51346 3.18343,1.40346 4.55264,1.95116 l 2.49881,0.99266 h 92.11377 92.14801 l 4.27878,-1.60882 c 4.17611,-1.57462 4.24454,-1.64308 3.11495,-1.9169 -0.65038,-0.13692 -4.89492,-0.41076 -9.41332,-0.58192 -8.59183,-0.30805 -173.51346,-0.34228 -184.8437,0 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 83.773955,-140.11759 c -4.621096,2.63572 -13.931743,7.80452 -20.709345,11.50139 -6.777598,3.66263 -12.665214,6.98297 -13.110207,7.42797 -0.753067,0.68462 -0.787298,0.85577 -0.410762,2.19074 0.205381,0.78731 0.581913,1.50613 0.821525,1.60882 0.273843,0.1027 1.471904,-0.27385 2.738426,-0.85574 2.259202,-1.0269 14.855953,-7.80451 25.227741,-13.58944 3.114955,-1.71153 8.215275,-4.48417 11.36446,-6.12722 5.613776,-2.90959 5.716464,-2.97806 5.716464,-4.07341 0,-1.19805 -0.547681,-1.84844 -2.156509,-2.53306 -0.513455,-0.23962 -0.992679,-0.41077 -1.02691,-0.41077 -0.03423,0.0342 -3.833794,2.19077 -8.454883,4.86072 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 303.9091,-143.36946 c -1.91689,1.5746 -2.08804,1.43767 21.35972,14.44518 11.98059,6.64069 21.97584,11.98062 22.24969,11.87793 0.71885,-0.27385 1.60882,-2.19073 1.4719,-3.21765 -0.1027,-0.78731 -0.75305,-1.26653 -5.06608,-3.59418 -2.73844,-1.47192 -10.88523,-5.9903 -18.14208,-9.99526 -15.78018,-8.76293 -17.66285,-9.68717 -19.57974,-9.96101 -1.16382,-0.17117 -1.64305,-0.0685 -2.29341,0.44499 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 98.15068,-141.41833 c 0,0.71882 0.376537,1.60882 0.992683,2.4646 0.54769,0.71881 9.516027,10.2006 19.922047,21.01737 10.44023,10.85102 27.28155,28.548103 37.44796,39.364874 10.1664,10.81679 23.51622,24.74854 29.67768,30.978431 l 11.1933,11.295996 0.0342,-2.669948 v -2.669967 l -8.11257,-8.626029 c -4.44995,-4.758021 -16.67017,-17.628614 -27.11041,-28.650798 -28.75347,-30.293809 -35.97606,-37.927179 -46.48476,-49.120479 -5.27148,-5.64799 -10.13218,-10.7483 -10.74833,-11.36446 -0.68461,-0.65038 -2.29343,-1.50616 -3.97071,-2.12228 l -2.841121,-1.0269 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 297.67918,-141.21297 c -1.26654,0.47923 -2.84113,1.19808 -3.52571,1.57462 -0.71885,0.37653 -6.50378,6.33259 -14.13714,14.51363 -12.22023,13.14446 -40.25485,42.616743 -67.46794,70.856771 l -12.35715,12.83635 v 3.080747 l -0.0342,3.080719 2.9438,-2.909595 c 6.50377,-6.401044 26.97349,-27.555379 37.61912,-38.851375 6.19569,-6.606458 18.58707,-19.682436 27.5554,-29.095787 30.08844,-31.62879 32.17649,-33.888 32.17649,-35.08608 0,-0.99266 -0.34228,-0.99266 -2.77264,0 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 55.568176,-116.32751 c -1.711517,0.85577 -2.259203,1.26651 -1.882667,1.4719 5.168775,2.84113 133.566681,74.690525 136.887011,76.607427 l 1.54037,0.889995 -2.12228,-2.361894 c -1.1296,-1.334969 -3.83379,-4.107644 -5.99031,-6.195689 -3.08073,-3.012262 -4.48416,-4.107614 -6.94875,-5.442622 -5.33993,-2.875323 -41.79521,-23.139682 -68.63177,-38.166784 -24.098146,-13.520983 -50.318564,-28.103113 -50.455483,-28.068873 0,0.0343 -1.095372,0.58192 -2.396121,1.26654 z"/>
                                    <path style="fill:none;stroke:#000000;stroke-width:0.0485154mm" d="m 338.96091,-117.11482 c -0.65035,0.44501 -78.49008,44.122867 -107.14085,60.108429 l -13.69214,7.667597 -5.06608,4.963407 c -5.7507,5.647998 -6.67491,6.811814 -4.31301,5.442613 3.76533,-2.190742 60.07419,-33.716874 109.94775,-61.546096 l 25.94659,-14.47944 -2.43036,-1.30073 c -1.33499,-0.75309 -2.46459,-1.33501 -2.49881,-1.33501 -0.0685,0 -0.37655,0.20538 -0.75309,0.47923 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 62.46342,-300.16683 c 0.482784,-0.29364 12.99128,-7.35796 27.796656,-15.69848 60.520594,-34.09391 84.453444,-47.67809 97.580894,-55.3865 l 5.99823,-3.52214 0.0887,2.38689 c 0.0753,2.02559 0.009,2.4458 -0.43889,2.7761 -0.29018,0.21407 -10.46856,5.98769 -22.61863,12.83026 -12.15006,6.84258 -36.64038,20.68484 -54.42293,30.76059 -17.782541,10.07575 -34.043586,19.27045 -36.135649,20.43267 -3.650189,2.0278 -4.093165,2.19074 -10.972366,4.03599 -3.942736,1.05758 -7.30028,1.92189 -7.461208,1.9207 -0.160928,-0.001 0.102409,-0.24243 0.585193,-0.53608 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 55.852251,-292.09638 c -1.030769,-0.52302 -1.874126,-1.08261 -1.874126,-1.24354 0,-0.16093 4.213388,-1.49839 9.363084,-2.97213 22.616067,-6.47229 118.026011,-32.9328 128.973061,-35.76873 1.70838,-0.44257 2.47091,-0.51732 3.04618,-0.2986 l 0.76736,0.29175 -0.99801,1.03195 c -2.39917,2.48077 -5.12348,3.68971 -13.87225,6.15591 -4.97922,1.4036 -75.52988,20.77959 -105.234523,28.90155 -9.761513,2.66902 -17.871605,4.85277 -18.022428,4.85277 -0.150822,0 -1.117579,-0.42792 -2.148348,-0.95093 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 198.14821,-334.562 -0.95772,-0.6192 0.16381,-18.72617 c 0.0901,-10.29939 0.23392,-19.53615 0.31959,-20.52613 0.15522,-1.79355 0.1595,-1.80065 1.20129,-1.99609 1.8093,-0.33943 1.95911,0.0483 2.17759,5.63504 0.10519,2.6899 0.20394,11.6935 0.21945,20.008 l 0.0282,15.11728 -1.09724,0.86324 -1.09724,0.86324 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 330.33541,-300.64296 -7.7538,-2.44546 -44.47465,-25.1241 c -24.46106,-13.81825 -51.02036,-28.80756 -59.02068,-33.30958 l -14.54603,-8.18548 -0.0106,-2.44522 c -0.009,-2.15724 0.0464,-2.42335 0.47346,-2.25946 0.26625,0.10217 3.92004,2.14047 8.11955,4.52955 4.1995,2.38909 20.86812,11.84696 37.04139,21.0175 56.58984,32.08746 88.6567,50.38153 88.6567,50.57845 0,0.27762 -1.12292,-0.0342 -8.4853,-2.3562 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 335.45584,-292.17088 c -3.76534,-1.07089 -98.6484,-27.27286 -120.01656,-33.14259 l -7.36697,-2.02367 -2.62459,-1.95419 c -2.84195,-2.11602 -3.46594,-2.71873 -3.14599,-3.03868 0.44259,-0.44258 2.56461,-0.0918 7.48397,1.23716 12.61251,3.40725 97.69506,26.92496 101.23835,27.98335 11.84429,3.53792 29.52735,9.14896 31.66405,10.04737 l 0.86158,0.36227 -1.43917,0.9235 c -0.79153,0.50793 -1.62512,0.90781 -1.85243,0.88862 -0.2273,-0.0192 -2.38831,-0.59661 -4.80224,-1.28314 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 298.29611,-148.5566 c -0.42602,-0.0863 -2.09333,-2.88089 -6.12974,-10.27418 -9.02527,-16.53113 -20.99806,-38.25465 -53.41165,-96.9105 -37.71104,-68.24216 -37.08433,-67.09691 -37.62922,-68.76284 -0.24545,-0.7504 -0.40525,-1.9732 -0.35513,-2.71733 l 0.0911,-1.35297 2.08532,1.5801 c 1.80362,1.36665 2.2731,1.92831 3.47548,4.15782 4.35017,8.06631 47.6233,86.43204 77.86658,141.01296 l 15.9091,28.7116 v 2.37676 c 0,2.58399 0.015,2.56675 -1.90188,2.17858 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 98.385927,-151.06492 c 0.232413,-2.64438 -2.297287,2.07245 38.249993,-71.32037 31.64972,-57.28776 39.86799,-72.23974 50.90077,-92.60676 2.61523,-4.82784 5.07226,-9.19967 5.46006,-9.71517 0.64878,-0.86242 3.94194,-3.59797 4.33138,-3.59797 0.0927,0 0.16852,0.95204 0.16852,2.11564 v 2.11564 l -5.52016,9.95396 c -3.03609,5.47468 -21.18987,38.26267 -40.34173,72.86219 -51.863467,93.69591 -50.12491,90.5905 -51.18235,91.42228 -0.41903,0.3296 -1.09157,0.59928 -1.494538,0.59928 -0.720823,0 -0.730073,-0.0296 -0.571945,-1.82872 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 304.00174,-147.47394 c -0.3359,-0.21196 -0.46205,-1.03167 -0.53757,-3.49296 l -0.0987,-3.21601 19.08157,-66.21364 c 10.49489,-36.41751 19.18663,-66.49255 19.31498,-66.83341 0.19132,-0.50801 2.85047,-2.4525 3.35389,-2.4525 0.8664,0 -3.02829,15.0219 -12.44116,47.98581 -18.24074,63.87916 -26.38123,91.72058 -27.39785,93.70399 -0.44771,0.87347 -0.60902,0.93909 -1.27519,0.51872 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 346.53466,-125.97846 -1.50281,-0.68721 -0.17444,-3.16572 c -0.19452,-3.53052 -0.35911,-15.23434 -0.77694,-55.24786 -0.15629,-14.96631 -0.41461,-38.46912 -0.57402,-52.22846 l -0.28985,-25.01699 2.01565,-9.80198 2.01567,-9.80198 0.0316,2.77967 c 0.0175,1.52881 0.22442,23.51743 0.46006,48.86359 0.23564,25.34616 0.57404,59.21359 0.75203,75.26095 0.17798,16.04736 0.2396,29.31295 0.13692,29.47909 -0.24313,0.39336 -0.32242,0.37696 -2.09389,-0.4331 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 103.48,-143.80003 c -2.06286,-0.86625 -3.808031,-1.63237 -3.878148,-1.70249 -0.361887,-0.36189 29.449688,-0.51457 99.478818,-0.50949 72.11852,0.005 97.73556,0.21334 99.34045,0.80702 0.53534,0.19804 0.016,0.48037 -2.9719,1.61554 l -3.62061,1.37557 -92.29897,-0.006 -92.29897,-0.006 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 200.43337,-38.571783 -0.0107,-2.716662 14.84926,-15.432008 c 24.81296,-25.786715 45.69132,-47.704027 64.01069,-67.195977 14.39488,-15.31626 14.45328,-15.37177 17.50666,-16.63822 5.64971,-2.34335 5.18122,-1.61471 -7.86935,12.2391 -2.42556,2.57484 -11.90749,12.58525 -21.07095,22.24536 -9.16346,9.660094 -21.26923,22.428092 -26.90172,28.373306 -11.87365,12.532968 -24.06405,25.173146 -33.71098,34.954818 l -6.79211,6.886971 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 338.96872,-121.76392 c -9.88254,-5.32631 -25.99897,-14.27074 -30.43174,-16.88927 -5.41369,-3.19798 -5.89958,-3.72794 -4.21611,-4.5985 1.34017,-0.69303 2.74538,-0.33246 6.80953,1.7473 5.306,2.71527 35.58621,19.44641 36.71681,20.28764 0.84791,0.63091 0.95586,0.85041 0.80036,1.62777 -0.19201,0.96014 -0.92414,2.24777 -1.27516,2.24274 -0.117,-0.002 -3.89866,-1.98964 -8.40369,-4.41768 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 208.90031,-39.732008 c -0.004,-0.120676 2.13543,-2.294784 4.75469,-4.831291 l 4.7623,-4.611846 43.30426,-24.260519 c 23.81735,-13.343281 51.13588,-28.667046 60.70787,-34.052796 l 17.40357,-9.79227 1.97551,1.06601 c 1.08654,0.5863 1.94504,1.16316 1.90778,1.28192 -0.0373,0.11875 -18.23796,10.36716 -40.44604,22.774267 -50.72295,28.337642 -70.04582,39.148914 -83.44527,46.688163 -5.82382,3.276811 -10.66263,5.957808 -10.75291,5.957808 -0.0903,0 -0.16758,-0.09874 -0.17176,-0.219446 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 89.276313,-159.84595 c -1.667569,-5.83192 -7.171905,-24.8895 -12.23186,-42.35019 -15.112389,-52.14924 -18.214002,-63.01714 -18.802557,-65.88325 -0.883403,-4.30196 -3.572119,-20.49038 -3.427279,-20.63522 0.245134,-0.24514 1.31562,0.60831 1.630872,1.30022 0.587466,1.28934 12.487191,42.15041 28.950349,99.40917 9.590011,33.354 9.418058,32.70899 9.613821,36.06251 l 0.157996,2.70651 -1.4297,-0.003 -1.429703,-0.003 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 49.265064,-129.41279 c 0.354638,-8.52261 1.145447,-66.31708 1.638487,-119.74508 0.164842,-17.863 0.386303,-33.59737 0.492136,-34.96526 0.226811,-2.93155 0.01564,-3.7783 2.132345,8.55019 l 1.49312,8.69648 -0.293374,32.26701 c -0.161356,17.74686 -0.433637,48.00138 -0.605069,67.23228 -0.171432,19.23089 -0.385487,36.18791 -0.475678,37.68225 l -0.163984,2.71699 -2.012779,1.01361 c -1.107028,0.55749 -2.097851,1.01362 -2.201828,1.01362 -0.103977,0 -0.105497,-2.00794 -0.0034,-4.46209 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 50.090998,-118.44043 c -0.65134,-1.7431 -0.648428,-1.85649 0.0643,-2.50365 0.388729,-0.35297 4.041258,-2.47812 8.116731,-4.72257 15.964504,-8.79197 20.823124,-11.49453 27.238926,-15.15138 7.095162,-4.04408 7.220651,-4.08464 8.79793,-2.84396 0.862954,0.6788 1.057632,2.02302 0.375028,2.58953 -0.222199,0.18441 -4.139334,2.3498 -8.704741,4.81197 -4.565409,2.46217 -11.724119,6.36224 -15.908247,8.66681 -9.080396,5.0014 -18.664348,9.95789 -19.254727,9.95789 -0.233493,0 -0.559834,-0.36209 -0.725201,-0.80464 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="m 189.38705,-44.751497 c -9.85444,-9.996885 -14.60137,-14.942556 -34.01067,-35.434561 -8.76309,-9.251923 -23.97444,-25.248442 -33.803,-35.547852 -23.427501,-24.54979 -22.351581,-23.39271 -22.840814,-24.56362 -0.762799,-1.82563 -0.641472,-1.95152 1.256342,-1.30356 3.686652,1.2587 4.003992,1.54439 16.869802,15.18741 6.75334,7.1613 23.94696,25.33155 38.20804,40.378293 14.26109,15.046775 29.57606,31.228136 34.03328,35.958595 l 8.10403,8.600836 v 2.298383 c 0,1.264126 -0.0329,2.277983 -0.0731,2.253033 -0.0402,-0.02487 -3.52497,-3.547084 -7.74386,-7.826957 z"/>
                                    <path style="fill:#000000;stroke-width:0.292597" d="M 153.14063,-59.503129 C 133.00941,-70.796842 102.50049,-87.87141 85.343035,-97.446628 68.185581,-107.02185 54.142434,-114.94607 54.136043,-115.056 c -0.0064,-0.10993 0.86403,-0.66485 1.934268,-1.23314 l 1.945888,-1.03328 14.366361,7.99185 c 7.901499,4.39549 27.335695,15.23452 43.1871,24.086711 15.85141,8.852191 35.53584,19.816471 43.74316,24.365055 19.60085,10.862945 19.39622,10.746052 20.92065,11.952023 2.87154,2.27166 10.46525,10.038556 9.75607,9.978549 -0.13568,-0.01138 -16.71769,-9.261184 -36.84891,-20.554897 z"/>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="149" y="-364" transform="scale(1.0849228,0.92172456)"><tspan x="149" y="-364">10</tspan></text>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="189" y="-364" transform="scale(1.0849228,0.92172456)"><tspan x="189" y="-364">20</tspan></text>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="54" y="-166" transform="scale(1.0849228,0.92172456)"><tspan x="54" y="-166">12</tspan></text>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="68" y="-122" transform="scale(1.0849228,0.92172456)"><tspan x="68" y="-122">18</tspan></text>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="267" y="-120" transform="scale(1.0849228,0.92172456)"><tspan x="267" y="-120">16</tspan></text>
                                    <text xml:space="preserve" style="font-size:24.1857px;fill:#000000" x="293" y="-160" transform="scale(1.0849228,0.92172456)"><tspan x="293" y="-160">14</tspan></text>
                                    <text xml:space="preserve" style="font-size:115.18px;fill:#000000" x="146" y="-190" transform="scale(1.0858342,0.92095091)"><tspan x="146" y="-190">2</tspan></text>
                                    <text xml:space="preserve" style="font-size:94.9442px;fill:#000000" x="236" y="-248" transform="scale(1.0977534,0.9109514)"><tspan x="236" y="-248">6</tspan></text>
                                    <text xml:space="preserve" style="font-size:94.9442px;fill:#000000" x="70" y="-246" transform="scale(1.0977534,0.9109514)"><tspan x="70" y="-246">4</tspan></text>
                                    <text xml:space="preserve" style="font-size:94.9442px;fill:#000000" x="151" y="-82" transform="scale(1.0977534,0.9109514)"><tspan x="151" y="-82">8</tspan></text>
                                    <!-- Highlight zones: circles around each number -->
                                    <g class="highlight-zones">
                                        <circle class="highlight-zone" data-number="2" cx="146" cy="-190" r="52"/>
                                        <circle class="highlight-zone" data-number="4" cx="70" cy="-246" r="40"/>
                                        <circle class="highlight-zone" data-number="6" cx="236" cy="-248" r="40"/>
                                        <circle class="highlight-zone" data-number="8" cx="151" cy="-82" r="40"/>
                                        <circle class="highlight-zone" data-number="10" cx="149" cy="-364" r="22"/>
                                        <circle class="highlight-zone" data-number="12" cx="54" cy="-166" r="22"/>
                                        <circle class="highlight-zone" data-number="14" cx="293" cy="-160" r="22"/>
                                        <circle class="highlight-zone" data-number="16" cx="267" cy="-120" r="22"/>
                                        <circle class="highlight-zone" data-number="18" cx="68" cy="-122" r="22"/>
                                        <circle class="highlight-zone" data-number="20" cx="189" cy="-364" r="22"/>
                                    </g>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions-section" id="actions-section">
                <h3 class="section-title">Actions</h3>
                <div class="hit-info" id="hit-info"></div>
                <div class="attack-prompt hidden" id="attack-prompt">Select a player to attack!</div>
                <div class="action-buttons">
                    <button class="btn btn-danger hidden" id="dropped-knife-btn">Dropped Knife (-1 HP)</button>
                    <button class="btn btn-primary hidden" id="end-turn-btn">End Turn</button>
                </div>
            </div>

            <div class="game-log">
                <h4>Game Log</h4>
                <div id="game-log-entries"></div>
            </div>
        </div>

        <!-- Winner Screen -->
        <div id="winner-screen">
            <h2 class="winner-title">Victory!</h2>
            <div class="winner-name" id="winner-name"></div>
            <div style="display: flex; justify-content: center; margin-bottom: 32px;">
                <button class="btn btn-secondary" id="export-report-btn">Export Game Report</button>
            </div>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-primary" id="play-again-btn">Play Again</button>
                <button class="btn btn-primary" id="finished-btn">Finished</button>
            </div>
        </div>
    </div>

    <!-- Game settings modal -->
    <div class="settings-modal-overlay" id="settings-modal" role="dialog" aria-label="Game settings">
        <div class="settings-modal">
            <h3>Game Settings</h3>
            <p id="settings-readonly-hint" class="setting-hint setting-readonly-hint" style="display: none;">Settings are locked after the first damage is dealt. Start a new game to change them.</p>
            <div class="option-row">
                <input type="checkbox" id="use-custom-hp-cb" aria-describedby="custom-hp-hint">
                <label for="use-custom-hp-cb">Use custom HP</label>
            </div>
            <div class="custom-hp-row">
                <label for="custom-hp-input">Default HP per player (20‚Äì999)</label>
                <input type="number" id="custom-hp-input" min="20" max="999" placeholder="e.g. 50" disabled>
            </div>
            <p id="custom-hp-hint" class="setting-hint">When unchecked, automatic values are used (2 players: 50, 3‚Äì4: 40, 5‚Äì6: 60).</p>
            <button type="button" class="btn btn-primary" id="settings-modal-done">Done</button>
        </div>
    </div>

    <!-- Player stats modal -->
    <div class="player-stats-modal-overlay" id="player-stats-modal" role="dialog" aria-label="Player stats">
        <div class="player-stats-modal">
            <h3 id="player-stats-title">Player</h3>
            <div class="player-stats-header">
                <div id="player-stats-avatar" class="player-stats-avatar"></div>
                <div class="player-stats-meta">
                    <div id="player-stats-hp" class="player-stats-row"></div>
                    <div id="player-stats-turn-order" class="player-stats-row"></div>
                    <div id="player-stats-status" class="player-stats-row"></div>
                    <div id="player-stats-hit-drop" class="player-stats-row"></div>
                    <div id="player-stats-rolled-claimed" class="player-stats-row"></div>
                    <div id="player-stats-critical" class="player-stats-row"></div>
                </div>
            </div>
            <div class="player-stats-section">
                <h4>Drops</h4>
                <p id="player-stats-drops-hint" class="setting-hint"></p>
                <button type="button" class="btn btn-secondary" id="player-stats-undo-drop-btn" style="display: none;">Undo last drop</button>
            </div>
            <button type="button" class="btn btn-primary" id="player-stats-close-btn">Close</button>
        </div>
    </div>

    <!-- Critical hit onscreen reaction -->
    <div class="critical-reaction" id="critical-reaction" aria-live="polite">
        <div class="critical-reaction-inner">Critical!</div>
    </div>

    <!-- Custom circular color picker modal (must be in DOM before script runs) -->
    <div class="color-picker-modal-overlay" id="color-picker-modal" role="dialog" aria-label="Pick color">
        <div class="color-picker-modal">
            <h3>Pick your color</h3>
            <div class="color-wheel-container" id="color-wheel-container">
                <div class="color-wheel-hue" id="color-wheel-hue"></div>
                <div class="color-wheel-inner"></div>
                <div class="color-wheel-sat" id="color-wheel-sat"></div>
                <div class="color-wheel-hue-handle" id="color-hue-handle"></div>
                <div class="color-wheel-sat-handle" id="color-sat-handle"></div>
            </div>
            <div class="color-picker-lightness">
                <label for="color-lightness-input">Brightness</label>
                <input type="range" id="color-lightness-input" min="0" max="100" value="50">
            </div>
            <button type="button" class="color-picker-done" id="color-picker-done">Done</button>
        </div>
    </div>

    <script>
        // Game State
        const state = {
            players: [],
            currentPlayerIndex: 0,
            phase: 'setup',
            currentRoll: [],
            hits: [],
            totalDamage: 0,
            hasRolled: false,
            hasAttacked: false,
            damageClaimedPhase: false,
            currentHitIndex: 0,
            attackLog: [],
            gameLog: [],
            autoDealDamage: false,
            hasScoreBeenEntered: false,
            lastDroppedKnifeLogIndex: undefined,
            dropsThisTurn: 0,
            dropsThisTurnLogIndices: [],
            damageDealtThisTurn: false
        };

        const COLORS = [
            { name: 'Red', hex: '#e74c3c' },
            { name: 'Blue', hex: '#3498db' },
            { name: 'Green', hex: '#2ecc71' },
            { name: 'Purple', hex: '#9b59b6' },
            { name: 'Orange', hex: '#e67e22' },
            { name: 'Pink', hex: '#fd79a8' },
            { name: 'Cyan', hex: '#00cec9' },
            { name: 'Yellow', hex: '#f1c40f' }
        ];

        function hexToHSL(hex) {
            const n = parseInt(hex.slice(1), 16);
            const r = (n >> 16) / 255, g = ((n >> 8) & 0xff) / 255, b = (n & 0xff) / 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h = 0, s = 0, l = (max + min) / 2;
            if (max !== min) {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                if (max === r) h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
                else if (max === g) h = ((b - r) / d + 2) / 6;
                else h = ((r - g) / d + 4) / 6;
            }
            return { h: h * 360, s: s * 100, l: l * 100 };
        }

        function hslToHex(h, s, l) {
            s /= 100; l /= 100;
            const a = s * Math.min(l, 1 - l);
            const f = n => {
                const k = (n + h / 30) % 12;
                return l - a * Math.max(-1, Math.min(k - 3, 9 - k, 1));
            };
            const r = Math.round(f(0) * 255), g = Math.round(f(8) * 255), b = Math.round(f(4) * 255);
            return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
        }

        // DOM Elements
        const setupScreen = document.getElementById('setup-screen');
        const turnOrderScreen = document.getElementById('turn-order-screen');
        const gameScreen = document.getElementById('game-screen');
        const winnerScreen = document.getElementById('winner-screen');
        const playerSetup = document.getElementById('player-setup');
        const startGameBtn = document.getElementById('start-game-btn');
        const playersPanel = document.getElementById('players-panel');
        const currentPlayerNameEl = document.getElementById('current-player-name');
        const rollDiceBtn = document.getElementById('roll-dice-btn');
        const diceResults = document.getElementById('dice-results');
        const hitInfo = document.getElementById('hit-info');
        const attackPrompt = document.getElementById('attack-prompt');
        const endTurnBtn = document.getElementById('end-turn-btn');
        const droppedKnifeBtn = document.getElementById('dropped-knife-btn');
        const gameLogEntries = document.getElementById('game-log-entries');

        // Custom circular color picker
        const colorPickerModal = document.getElementById('color-picker-modal');
        const colorWheelContainer = document.getElementById('color-wheel-container');
        const colorWheelSat = document.getElementById('color-wheel-sat');
        const colorHueHandle = document.getElementById('color-hue-handle');
        const colorSatHandle = document.getElementById('color-sat-handle');
        const colorLightnessInput = document.getElementById('color-lightness-input');
        const colorPickerDone = document.getElementById('color-picker-done');

        const settingsModal = document.getElementById('settings-modal');
        const settingsGearBtn = document.getElementById('settings-gear-btn');
        const useCustomHpCb = document.getElementById('use-custom-hp-cb');
        const customHpInput = document.getElementById('custom-hp-input');
        const settingsModalDone = document.getElementById('settings-modal-done');

        useCustomHpCb.addEventListener('change', () => {
            customHpInput.disabled = !useCustomHpCb.checked;
        });

        const settingsReadOnlyHint = document.getElementById('settings-readonly-hint');

        settingsGearBtn.addEventListener('click', () => {
            const readOnly = state.hasScoreBeenEntered;
            const useCustom = localStorage.getItem(USE_CUSTOM_HP_KEY) === 'true';
            useCustomHpCb.checked = useCustom;
            if (useCustom) {
                const savedHp = localStorage.getItem(CUSTOM_HP_KEY);
                customHpInput.value = savedHp !== null && savedHp !== '' ? savedHp : '';
            } else {
                customHpInput.value = state.players.length > 0 ? String(getDefaultHp(state.players.length)) : '';
            }
            useCustomHpCb.disabled = readOnly;
            customHpInput.disabled = readOnly || !useCustomHpCb.checked;
            if (settingsReadOnlyHint) settingsReadOnlyHint.style.display = readOnly ? 'block' : 'none';
            settingsModalDone.textContent = readOnly ? 'Close' : 'Done';
            settingsModal.classList.add('open');
        });

        settingsModalDone.addEventListener('click', () => {
            if (state.hasScoreBeenEntered) {
                settingsModal.classList.remove('open');
                return;
            }
            if (useCustomHpCb.checked) {
                const val = customHpInput.value.trim();
                const n = val === '' ? NaN : parseInt(val, 10);
                if (isNaN(n) || n < 20 || n > 999) {
                    alert('Please enter a value between 20 and 999.');
                    return;
                }
                localStorage.setItem(USE_CUSTOM_HP_KEY, 'true');
                localStorage.setItem(CUSTOM_HP_KEY, String(n));
                if (state.players.length > 0) {
                    state.players.forEach(p => {
                        p.hp = n;
                        p.maxHp = n;
                    });
                    updatePlayersPanel();
                    if (state.damageClaimedPhase) enableTargetSelection();
                }
            } else {
                localStorage.setItem(USE_CUSTOM_HP_KEY, 'false');
                if (state.players.length > 0) {
                    const defaultHp = getDefaultHp(state.players.length);
                    state.players.forEach(p => {
                        p.hp = defaultHp;
                        p.maxHp = defaultHp;
                    });
                    updatePlayersPanel();
                    if (state.damageClaimedPhase) enableTargetSelection();
                }
            }
            settingsModal.classList.remove('open');
        });

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) settingsModal.classList.remove('open');
        });

        let colorPickerState = { wrap: null, input: null, swatch: null, h: 0, s: 100, l: 50 };
        const WHEEL_SIZE = 260;
        const WHEEL_PADDING = 12;
        const WHEEL_INNER_R = (WHEEL_SIZE / 2) - WHEEL_PADDING;

        function openColorPicker(wrap) {
            const input = wrap.querySelector('.player-color-input');
            const swatch = wrap.querySelector('.color-swatch');
            const hex = input.value || '#e74c3c';
            const hsl = hexToHSL(hex);
            colorPickerState = { wrap, input, swatch, h: hsl.h, s: hsl.s, l: hsl.l };
            colorLightnessInput.value = Math.round(hsl.l);
            colorPickerModal.classList.add('open');
            updatePickerGradient();
            updatePickerHandles();
        }

        function updatePickerGradient() {
            const { h } = colorPickerState;
            const gray = hslToHex(h, 0, 50);
            const hueColor = hslToHex(h, 100, 50);
            colorWheelSat.style.setProperty('--picker-gray', gray);
            colorWheelSat.style.setProperty('--picker-hue-color', hueColor);
        }

        function updatePickerHandles() {
            const { h, s } = colorPickerState;
            const rad = (h - 90) * Math.PI / 180;
            const hueR = 48;
            colorHueHandle.style.left = (50 + hueR * Math.cos(rad)) + '%';
            colorHueHandle.style.top = (50 + hueR * Math.sin(rad)) + '%';
            const satR = (s / 100) * 42;
            colorSatHandle.style.left = (50 + satR) + '%';
            colorSatHandle.style.top = '50%';
        }

        function commitPickerColor() {
            const { input, swatch, h, s, l } = colorPickerState;
            const hex = hslToHex(h, s, l);
            if (input) input.value = hex;
            if (swatch) swatch.style.background = hex;
        }

        function getWheelXY(e) {
            const rect = colorWheelContainer.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const x = (e.clientX ?? e.touches?.[0]?.clientX) - cx;
            const y = (e.clientY ?? e.touches?.[0]?.clientY) - cy;
            const dist = Math.sqrt(x * x + y * y);
            const angle = Math.atan2(y, x);
            return { x, y, dist, angle };
        }

        function onWheelPointerDown(e) {
            e.preventDefault();
            const { dist, angle } = getWheelXY(e);
            const isHue = dist > WHEEL_INNER_R;
            let move = (e2) => {
                const xy = getWheelXY(e2);
                if (isHue) {
                    colorPickerState.h = ((xy.angle * 180 / Math.PI + 90) + 360) % 360;
                    updatePickerGradient();
                } else {
                    colorPickerState.s = Math.min(100, Math.max(0, (xy.dist / WHEEL_INNER_R) * 100));
                    updatePickerHandles();
                }
                updatePickerHandles();
                commitPickerColor();
            };
            const up = () => {
                document.removeEventListener('pointermove', move);
                document.removeEventListener('pointerup', up);
                document.removeEventListener('touchmove', move, { passive: false });
                document.removeEventListener('touchend', up);
            };
            if (isHue) {
                colorPickerState.h = ((angle * 180 / Math.PI + 90) + 360) % 360;
                updatePickerGradient();
            } else {
                colorPickerState.s = Math.min(100, Math.max(0, (dist / WHEEL_INNER_R) * 100));
            }
            updatePickerHandles();
            commitPickerColor();
            document.addEventListener('pointermove', move);
            document.addEventListener('pointerup', up);
            document.addEventListener('touchmove', move, { passive: false });
            document.addEventListener('touchend', up);
        }

        document.addEventListener('click', (e) => {
            const wrap = e.target.closest('.color-picker-wrap');
            if (wrap) {
                e.preventDefault();
                openColorPicker(wrap);
            }
        });

        colorWheelContainer.addEventListener('pointerdown', onWheelPointerDown);
        colorWheelContainer.addEventListener('touchstart', onWheelPointerDown, { passive: false });

        colorLightnessInput.addEventListener('input', () => {
            colorPickerState.l = parseInt(colorLightnessInput.value, 10);
            commitPickerColor();
        });

        colorPickerDone.addEventListener('click', () => {
            colorPickerModal.classList.remove('open');
        });

        colorPickerModal.addEventListener('click', (e) => {
            if (e.target === colorPickerModal) colorPickerModal.classList.remove('open');
        });

        // Setup: Player count selection
        document.querySelectorAll('.player-count-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.player-count-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                const count = parseInt(btn.dataset.count);
                setupPlayerInputs(count);
            });
        });

        function setupPlayerInputs(count) {
            playerSetup.innerHTML = '';
            playerSetup.classList.add('visible');
            const setupError = document.getElementById('setup-error');
            if (setupError) {
                setupError.classList.add('hidden');
                setupError.textContent = '';
            }

            const usedColors = new Set();

            for (let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.className = 'player-input';
                const defaultHex = COLORS[i % COLORS.length].hex;
                div.innerHTML = `
                    <span>P${i + 1}</span>
                    <input type="text" placeholder="Player ${i + 1} Name" data-player="${i}" maxlength="30">
                    <div class="color-picker" data-player="${i}">
                        <div class="color-picker-wrap" data-player="${i}" title="Pick your color">
                            <span class="color-swatch" style="background: ${defaultHex};"></span>
                            <input type="color" class="player-color-input" data-player="${i}" value="${defaultHex}" aria-hidden="true">
                        </div>
                    </div>
                `;
                playerSetup.appendChild(div);
            }

            playerSetup.querySelectorAll('input[type="text"]').forEach(input => {
                input.addEventListener('input', checkDuplicateNames);
            });

            startGameBtn.style.display = 'block';
        }

        function checkDuplicateNames() {
            const inputs = playerSetup.querySelectorAll('input[type="text"]');
            const errorEl = document.getElementById('setup-error');

            document.querySelectorAll('.player-input').forEach(el => el.classList.remove('error-duplicate'));

            const names = [];
            for (let idx = 0; idx < inputs.length; idx++) {
                const raw = inputs[idx].value.trim();
                names.push(raw || `Player ${idx + 1}`);
            }

            const nameCount = {};
            names.forEach(n => {
                const key = n.toLowerCase();
                nameCount[key] = (nameCount[key] || 0) + 1;
            });

            const duplicates = new Set(Object.entries(nameCount).filter(([, c]) => c > 1).map(([k]) => k));

            if (duplicates.size > 0) {
                inputs.forEach((input, idx) => {
                    if (duplicates.has(names[idx].toLowerCase())) {
                        input.closest('.player-input').classList.add('error-duplicate');
                    }
                });
                errorEl.textContent = `Names must be unique: ${[...duplicates].join(', ')} appears more than once.`;
                errorEl.classList.remove('hidden');
            } else {
                errorEl.classList.add('hidden');
                errorEl.textContent = '';
            }
        }

        const CUSTOM_HP_KEY = 'daggerdie_customHp';
        const USE_CUSTOM_HP_KEY = 'daggerdie_useCustomHp';

        function getDefaultHp(playerCount) {
            if (localStorage.getItem(USE_CUSTOM_HP_KEY) === 'true') {
                const custom = localStorage.getItem(CUSTOM_HP_KEY);
                if (custom !== null && custom !== '') {
                    const n = parseInt(custom, 10);
                    if (!isNaN(n) && n >= 20 && n <= 999) return n;
                }
            }
            if (playerCount <= 2) return 50;
            if (playerCount <= 4) return 40;
            return 60; // 5-6 players
        }

        const NAME_MIN_LEN = 2;
        const NAME_MAX_LEN = 30;

        function validatePlayerNames() {
            const inputs = playerSetup.querySelectorAll('input[type="text"]');
            const errorEl = document.getElementById('setup-error');
            const names = [];
            let firstInvalidInput = null;

            document.querySelectorAll('.player-input').forEach(el => el.classList.remove('error', 'error-duplicate'));

            for (let idx = 0; idx < inputs.length; idx++) {
                const raw = inputs[idx].value.trim();
                names.push(raw || `Player ${idx + 1}`);
            }

            const duplicateNames = new Set(
                names.filter((n, i) => names.findIndex(x => x.toLowerCase() === n.toLowerCase()) !== i)
                    .map(n => n.toLowerCase())
            );

            for (let idx = 0; idx < inputs.length; idx++) {
                const input = inputs[idx];
                const raw = input.value.trim();
                const name = raw || `Player ${idx + 1}`;
                const playerInputEl = input.closest('.player-input');

                if (raw) {
                    if (raw.length < NAME_MIN_LEN) {
                        if (!firstInvalidInput) firstInvalidInput = input;
                        playerInputEl.classList.add('error');
                    } else if (raw.length > NAME_MAX_LEN) {
                        if (!firstInvalidInput) firstInvalidInput = input;
                        playerInputEl.classList.add('error');
                    }
                }

                if (duplicateNames.has(name.toLowerCase())) {
                    if (!firstInvalidInput) firstInvalidInput = input;
                    playerInputEl.classList.add('error', 'error-duplicate');
                }
            }

            const errors = [];
            inputs.forEach((input, idx) => {
                const el = input.closest('.player-input');
                if (!el.classList.contains('error')) return;
                const raw = input.value.trim();
                if (raw && raw.length < NAME_MIN_LEN) {
                    errors.push(`"${raw || input.value}" is too short (min ${NAME_MIN_LEN} characters).`);
                } else if (raw && raw.length > NAME_MAX_LEN) {
                    errors.push(`"${input.value}" is too long (max ${NAME_MAX_LEN} characters).`);
                }
            });
            if (duplicateNames.size > 0) {
                errors.push(`Names must be unique: ${[...duplicateNames].join(', ')} appears more than once.`);
            }

            if (errors.length > 0) {
                errorEl.textContent = errors.join(' ');
                errorEl.classList.remove('hidden');
                if (firstInvalidInput) firstInvalidInput.focus();
                return false;
            }
            errorEl.classList.add('hidden');
            errorEl.textContent = '';
            return true;
        }

        startGameBtn.addEventListener('click', () => {
            if (!validatePlayerNames()) return;

            const nameInputs = playerSetup.querySelectorAll('input[type="text"]');
            state.players = [];
            const defaultHp = getDefaultHp(nameInputs.length);

            nameInputs.forEach((input, idx) => {
                const colorPicker = playerSetup.querySelector(`.color-picker[data-player="${idx}"]`);
                const colorInput = colorPicker.querySelector('input[type="color"]');
                const hex = colorInput ? colorInput.value : COLORS[idx % COLORS.length].hex;
                const name = input.value.trim() || `Player ${idx + 1}`;

                state.players.push({
                    id: idx,
                    name,
                    color: { name: 'Custom', hex },
                    hp: defaultHp,
                    maxHp: defaultHp,
                    turnOrderRoll: 0,
                    eliminated: false,
                    totalRolled: 0,
                    totalClaimed: 0,
                    criticals: 0
                });
            });

            state.autoDealDamage = localStorage.getItem('daggerdie_autoDealDamage') === 'true';

            showTurnOrderScreen();

            if (localStorage.getItem('daggerdie_autoRollTurnOrder') === 'true') {
                setTimeout(() => {
                    document.getElementById('roll-turn-order-btn')?.click();
                }, 400);
            }
        });

        function showTurnOrderScreen() {
            setupScreen.style.display = 'none';
            turnOrderScreen.style.display = 'block';

            const rollBtn = document.getElementById('roll-turn-order-btn');
            if (localStorage.getItem('daggerdie_autoRollTurnOrder') === 'true') {
                rollBtn.classList.add('hidden');
            }

            const rollsDiv = document.getElementById('turn-order-rolls');
            rollsDiv.innerHTML = state.players.map(p => `
                <div class="turn-order-player" data-player="${p.id}">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; border-radius: 50%; background: ${p.color.hex};"></div>
                        <span>${p.name}</span>
                    </div>
                    <span class="roll-value">-</span>
                </div>
            `).join('');
        }

        document.getElementById('roll-turn-order-btn').addEventListener('click', async () => {
            const btn = document.getElementById('roll-turn-order-btn');
            btn.disabled = true;

            for (let player of state.players) {
                const playerDiv = document.querySelector(`.turn-order-player[data-player="${player.id}"]`);
                const rollValue = playerDiv.querySelector('.roll-value');

                for (let i = 0; i < 10; i++) {
                    rollValue.textContent = rollD20();
                    await sleep(50);
                }

                player.turnOrderRoll = rollD20();
                rollValue.textContent = player.turnOrderRoll;
                await sleep(300);
            }

            state.players.sort((a, b) => b.turnOrderRoll - a.turnOrderRoll);

            const rollsDiv = document.getElementById('turn-order-rolls');
            const tieMessage = document.createElement('p');
            tieMessage.id = 'tie-reroll-message';
            tieMessage.style.cssText = 'color: #feca57; margin: 15px 0; font-weight: bold;';
            tieMessage.style.display = 'none';
            if (!document.getElementById('tie-reroll-message')) {
                rollsDiv.parentNode.insertBefore(tieMessage, rollsDiv.nextSibling);
            }

            function updateTurnOrderDisplay() {
                rollsDiv.innerHTML = state.players.map((p, idx) => `
                    <div class="turn-order-player" data-player="${p.id}">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-weight: bold; width: 25px;">#${idx + 1}</span>
                            <div style="width: 30px; height: 30px; border-radius: 50%; background: ${p.color.hex};"></div>
                            <span>${p.name}</span>
                        </div>
                        <span class="roll-value">${p.turnOrderRoll}</span>
                    </div>
                `).join('');
            }

            // Find tie groups (consecutive players with same roll) - each resolves independently
            const tieGroupsWithIndex = [];
            for (let i = 0; i < state.players.length; i++) {
                const startIdx = i;
                const group = [state.players[i]];
                while (i + 1 < state.players.length && state.players[i + 1].turnOrderRoll === state.players[i].turnOrderRoll) {
                    group.push(state.players[++i]);
                }
                if (group.length > 1) {
                    tieGroupsWithIndex.push({ startIdx, players: group });
                }
            }

            // Resolve each tie group in isolation - only the tied players reroll for their slots
            for (const { startIdx, players: tiedPlayers } of tieGroupsWithIndex) {
                let hasTieInGroup;
                do {
                    hasTieInGroup = false;
                    tieMessage.textContent = `Tie between ${tiedPlayers.map(p => p.name).join(', ')}! Rerolling for slot...`;
                    tieMessage.style.display = 'block';
                    await sleep(500);

                    for (let player of tiedPlayers) {
                        const playerDiv = document.querySelector(`.turn-order-player[data-player="${player.id}"]`);
                        if (playerDiv) {
                            const rollValue = playerDiv.querySelector('.roll-value');
                            for (let i = 0; i < 8; i++) {
                                rollValue.textContent = rollD20();
                                await sleep(40);
                            }
                        }
                        player.turnOrderRoll = rollD20();
                        const div = document.querySelector(`.turn-order-player[data-player="${player.id}"]`);
                        if (div) div.querySelector('.roll-value').textContent = player.turnOrderRoll;
                        await sleep(200);
                    }

                    tiedPlayers.sort((a, b) => b.turnOrderRoll - a.turnOrderRoll);

                    for (let j = 0; j < tiedPlayers.length - 1; j++) {
                        if (tiedPlayers[j].turnOrderRoll === tiedPlayers[j + 1].turnOrderRoll) {
                            hasTieInGroup = true;
                            break;
                        }
                    }

                    for (let j = 0; j < tiedPlayers.length; j++) {
                        state.players[startIdx + j] = tiedPlayers[j];
                    }
                    updateTurnOrderDisplay();
                    tieMessage.style.display = 'none';
                    await sleep(300);
                } while (hasTieInGroup);
            }

            tieMessage.style.display = 'none';
            await sleep(500);
            rollsDiv.innerHTML = state.players.map((p, idx) => `
                <div class="turn-order-player" data-player="${p.id}">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: bold; width: 25px;">#${idx + 1}</span>
                        <div style="width: 30px; height: 30px; border-radius: 50%; background: ${p.color.hex};"></div>
                        <span>${p.name}</span>
                    </div>
                    <span class="roll-value">${p.turnOrderRoll}</span>
                </div>
            `).join('');

            btn.classList.add('hidden');
            const beginBtn = document.getElementById('begin-game-btn');
            beginBtn.classList.remove('hidden');
            if (localStorage.getItem('daggerdie_autoBeginGame') === 'true') {
                beginBtn.classList.add('hidden');
                setTimeout(() => beginBtn.click(), 500);
            }
        });

        document.getElementById('begin-game-btn').addEventListener('click', () => {
            turnOrderScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            state.phase = 'playing';
            state.currentPlayerIndex = 0;
            state.gameLog = [];
            state.hasScoreBeenEntered = false;
            state.lastDroppedKnifeLogIndex = undefined;
            state.dropsThisTurn = 0;
            state.dropsThisTurnLogIndices = [];
            state.damageDealtThisTurn = false;
            updateGameUI();
        });

        function rollD20() {
            return Math.floor(Math.random() * 20) + 1;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function getCurrentPlayer() {
            return state.players[state.currentPlayerIndex];
        }

        function getAlivePlayers() {
            return state.players.filter(p => !p.eliminated);
        }

        function updateGameUI() {
            updatePlayersPanel();
            updateCurrentPlayerDisplay();
            clearHighlights();
            resetDice();
            diceResults.innerHTML = '';
            hitInfo.innerHTML = '';
            attackPrompt.classList.add('hidden');
            endTurnBtn.classList.add('hidden');
            state.hasRolled = false;
            state.hasAttacked = false;
            state.damageClaimedPhase = false;
            state.hits = [];
            state.totalDamage = 0;
            state.currentHitIndex = 0;
            state.attackLog = [];
            rollDiceBtn.disabled = false;
            disableTargetSelection();
            droppedKnifeBtn.classList.add('hidden');

            if (localStorage.getItem('daggerdie_autoRollDice') === 'true') {
                rollDiceBtn.classList.add('hidden');
                setTimeout(() => rollDiceBtn.click(), 300);
            } else {
                rollDiceBtn.classList.remove('hidden');
            }
        }

        function updatePlayersPanel() {
            const currentPlayer = getCurrentPlayer();
            playersPanel.innerHTML = state.players.map(p => `
                <div class="player-card ${p.id === currentPlayer.id ? 'current' : ''} ${p.eliminated ? 'eliminated' : ''}"
                     data-player="${p.id}">
                    <button type="button" class="player-card-stats-btn" data-player="${p.id}" aria-label="Stats and drops">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    </button>
                    <div class="player-avatar" style="background: ${p.color.hex};"></div>
                    <div class="player-name">${p.name}</div>
                    <div class="player-hp">${p.hp} HP</div>
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: ${(p.hp / p.maxHp) * 100}%; background: ${p.color.hex};"></div>
                    </div>
                    <div class="player-turn-order">Turn Order: #${state.players.indexOf(p) + 1}</div>
                </div>
            `).join('');
        }

        function updateCurrentPlayerDisplay() {
            const current = getCurrentPlayer();
            currentPlayerNameEl.textContent = current.name;
            currentPlayerNameEl.style.color = current.color.hex;
        }

        rollDiceBtn.addEventListener('click', async () => {
            if (state.hasRolled) return;

            rollDiceBtn.disabled = true;
            const dice = [
                document.getElementById('die1'),
                document.getElementById('die2'),
                document.getElementById('die3')
            ];

            dice.forEach(die => {
                die.classList.add('rolling');
                die.classList.remove('odd', 'even');
            });

            for (let i = 0; i < 15; i++) {
                dice.forEach(die => {
                    die.textContent = rollD20();
                });
                await sleep(50);
            }

            state.currentRoll = [rollD20(), rollD20(), rollD20()];
            state.hits = [];
            state.totalDamage = 0;
            state.damageClaimedPhase = false;

            dice.forEach((die, idx) => {
                die.classList.remove('rolling');
                const value = state.currentRoll[idx];
                die.textContent = value;
                die.classList.add(value % 2 === 0 ? 'even' : 'odd');
            });

            highlightTargets(state.currentRoll);
            displayRollResults();

            state.hasRolled = true;
            const current = getCurrentPlayer();
            current.totalRolled = (current.totalRolled || 0) + state.currentRoll.reduce((s, v) => s + v, 0);
            showHitRecorder();
            droppedKnifeBtn.classList.remove('hidden');
        });

        function highlightTargets(rolls) {
            clearHighlights();
            rolls.forEach(roll => {
                const zone = document.querySelector(`.highlight-zone[data-number="${roll}"]`);
                if (zone) {
                    zone.classList.add('active');
                }
            });
        }

        function clearHighlights() {
            document.querySelectorAll('.highlight-zone').forEach(zone => {
                zone.classList.remove('active');
            });
        }

        document.addEventListener('click', (e) => {
            const zone = e.target.closest('.highlight-zone');
            if (!zone) return;
            const overlay = zone.closest('.target-overlay');
            if (!overlay || !overlay.classList.contains('clickable')) return;
            const number = parseInt(zone.getAttribute('data-number'));
            if (!state.currentRoll.includes(number)) return;

            const rollIndices = state.currentRoll.map((r, i) => r === number ? i : -1).filter(i => i >= 0);
            const hitIndicesForNumber = new Set(state.hits.filter(h => h.roll === number).map(h => h.idx));
            const firstUnclaimed = rollIndices.find(idx => !hitIndicesForNumber.has(idx));
            if (firstUnclaimed !== undefined) {
                const slotsLeft = MAX_SCORES_PER_TURN - state.dropsThisTurn;
                if (state.hits.length >= slotsLeft) return;
                state.hits.push({ roll: number, idx: firstUnclaimed });
            } else {
                const toRemove = state.hits.find(h => h.roll === number);
                if (toRemove) state.hits = state.hits.filter(h => h !== toRemove);
            }
            syncHitRecorderUI();
        });

        function displayRollResults() {
            diceResults.innerHTML = `
                <p>Rolled: <strong>${state.currentRoll.join(', ')}</strong></p>
                <p>Odd targets: <span style="color: #ff6b6b;">${state.currentRoll.filter(r => r % 2 === 1).join(', ') || 'None'}</span></p>
                <p>Even targets: <span style="color: #48dbfb;">${state.currentRoll.filter(r => r % 2 === 0).join(', ') || 'None'}</span></p>
            `;
        }

        const MAX_SCORES_PER_TURN = 3;

        function syncHitRecorderUI() {
            const hitIdxSet = new Set(state.hits.map(h => h.idx));
            hitInfo.querySelectorAll('.hit-toggle').forEach(btn => {
                const idx = parseInt(btn.dataset.idx);
                if (hitIdxSet.has(idx)) {
                    btn.classList.add('hit');
                    btn.style.background = '#2ecc71';
                } else {
                    btn.classList.remove('hit');
                    btn.style.background = '';
                }
            });
            const totalDamageEl = document.getElementById('total-damage-display');
            if (totalDamageEl) totalDamageEl.textContent = state.hits.reduce((sum, h) => sum + h.roll, 0);
            const scoreCounter = hitInfo.querySelector('.scores-counter');
            if (scoreCounter) scoreCounter.textContent = `Scores: ${state.hits.length + state.dropsThisTurn} / ${MAX_SCORES_PER_TURN}`;
            document.querySelectorAll('.highlight-zone').forEach(zone => {
                const num = parseInt(zone.getAttribute('data-number'));
                const claimedForNumber = state.hits.some(h => h.roll === num);
                zone.classList.toggle('claimed', claimedForNumber);
            });
        }

        function showHitRecorder(initialHits) {
            const currentPlayer = getCurrentPlayer();
            droppedKnifeBtn.classList.remove('hidden');

            state.hits = initialHits && initialHits.length > 0 ? initialHits.slice() : [];

            const maxDiceScores = Math.max(0, MAX_SCORES_PER_TURN - state.dropsThisTurn);
            state.hits = initialHits && initialHits.length > 0 ? initialHits.slice(0, maxDiceScores) : [];

            attackPrompt.classList.remove('hidden');
            attackPrompt.innerHTML = `<strong>Step 1:</strong> Throw your knives! Tap the target numbers you HIT, or use the buttons below (max 3 scores per turn).`;

            const hitIdxSet = new Set(state.hits.map(h => h.idx));

            hitInfo.innerHTML = `
                <div style="width: 100%; text-align: center; margin-bottom: 15px;">
                    <p style="font-size: 1.1rem;">Tap the <strong>highlighted targets</strong> or buttons below to claim hits (max 3 per turn):</p>
                </div>
                <div style="margin-bottom: 12px; display: flex; flex-direction: column; align-items: center; gap: 2px;">
                    <div class="scores-counter" style="font-size: 0.9rem; opacity: 0.9;">Scores: ${state.hits.length + state.dropsThisTurn} / ${MAX_SCORES_PER_TURN}</div>
                    <p style="font-size: 1.3rem; margin: 0;">Damage Claimed: <strong id="total-damage-display" style="color: #feca57; font-size: 1.5rem;">${state.hits.reduce((sum, h) => sum + h.roll, 0)}</strong></p>
                </div>
                <div class="hit-buttons" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    ${state.currentRoll.map((roll, idx) => `
                        <button class="btn hit-toggle ${hitIdxSet.has(idx) ? 'hit' : ''}" data-roll="${roll}" data-idx="${idx}" style="min-width: 70px; font-size: 1.3rem; ${hitIdxSet.has(idx) ? 'background: #2ecc71;' : ''}">
                            ${roll}
                        </button>
                    `).join('')}
                </div>
                <div style="margin-top: 12px;">
                    <button class="btn btn-primary" id="confirm-hits-btn">Confirm</button>
                </div>
            `;

            document.getElementById('odd-overlay').classList.add('clickable');
            document.getElementById('even-overlay').classList.add('clickable');
            syncHitRecorderUI();

            hitInfo.querySelectorAll('.hit-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    const roll = parseInt(btn.dataset.roll);
                    const idx = parseInt(btn.dataset.idx);

                    if (btn.classList.contains('hit')) {
                        state.hits = state.hits.filter(h => h.idx !== idx);
                    } else {
                        const slotsLeft = MAX_SCORES_PER_TURN - state.dropsThisTurn;
                        if (state.hits.length >= slotsLeft) return;
                        state.hits.push({ roll, idx });
                    }
                    syncHitRecorderUI();
                });
            });

            document.getElementById('confirm-hits-btn').addEventListener('click', () => {
                document.getElementById('odd-overlay').classList.remove('clickable');
                document.getElementById('even-overlay').classList.remove('clickable');
                state.totalDamage = state.hits.reduce((sum, h) => sum + h.roll, 0);

                if (state.totalDamage > 0) {
                    const isCritical = state.hits.length === MAX_SCORES_PER_TURN;
                    if (isCritical) {
                        currentPlayer.criticals = (currentPlayer.criticals || 0) + 1;
                        addLogEntry(`${currentPlayer.name} claimed ${state.totalDamage} damage points! (Hit: ${state.hits.map(h => h.roll).join(', ')}) ‚Äî Critical!`, 'info');
                        showCriticalReaction(currentPlayer.name);
                    } else {
                        addLogEntry(`${currentPlayer.name} claimed ${state.totalDamage} damage points! (Hit: ${state.hits.map(h => h.roll).join(', ')})`, 'info');
                    }
                    showTargetSelection();
                } else {
                    if (confirm('No hits recorded. Did you miss all targets?')) {
                        addLogEntry(`${currentPlayer.name} missed all targets!`, 'info');
                        finishTurnNoAttack();
                    }
                }
            });
        }

        function showTargetSelection() {
            droppedKnifeBtn.classList.add('hidden');
            state.damageDealtThisTurn = true;
            state.damageClaimedPhase = true;
            state.currentHitIndex = 0;
            state.attackLog = [];
            state.attackAssignments = [];

            if (state.autoDealDamage) {
                autoDealDamageAndFinish();
                return;
            }
            showNextHitToAssign();
        }

        function autoDealDamageAndFinish() {
            const currentPlayer = getCurrentPlayer();
            for (let i = 0; i < state.hits.length; i++) {
                const aliveOpponents = state.players.filter(p => !p.eliminated && p.id !== currentPlayer.id);
                if (aliveOpponents.length === 0) break;
                const currentHit = state.hits[i];
                const targetPlayer = aliveOpponents[Math.floor(Math.random() * aliveOpponents.length)];
                state.attackAssignments.push({ playerId: targetPlayer.id, roll: currentHit.roll });
                targetPlayer.hp = Math.max(0, targetPlayer.hp - currentHit.roll);
                state.hasScoreBeenEntered = true;
                currentPlayer.totalClaimed = (currentPlayer.totalClaimed || 0) + currentHit.roll;
                addLogEntry(`${currentPlayer.name} dealt ${currentHit.roll} damage to ${targetPlayer.name}!`, 'damage');
                state.attackLog.push(`${currentHit.roll} ‚Üí ${targetPlayer.name}`);
                if (targetPlayer.hp <= 0) {
                    targetPlayer.eliminated = true;
                    addLogEntry(`${targetPlayer.name} has been eliminated!`, 'info');
                }
                updatePlayersPanel();
                checkWinCondition();
            }
            finishAttackPhase();
        }

        function showNextHitToAssign() {
            const currentPlayer = getCurrentPlayer();

            if (state.currentHitIndex >= state.hits.length) {
                finishAttackPhase();
                return;
            }

            const aliveOpponents = state.players.filter(p => !p.eliminated && p.id !== currentPlayer.id);
            if (aliveOpponents.length === 0) {
                finishAttackPhase();
                return;
            }

            const currentHit = state.hits[state.currentHitIndex];
            const remainingHits = state.hits.slice(state.currentHitIndex);

            attackPrompt.innerHTML = `<strong>Step 2:</strong> Assign hit <span style="color: #feca57; font-size: 1.3rem;">${currentHit.roll}</span> damage - Click an opponent to attack!`;

            hitInfo.innerHTML = `
                <div class="editable-hits-box" id="editable-hits-box" style="background: rgba(46, 204, 113, 0.2); padding: 10px; border-radius: 10px; border: 2px solid #2ecc71; margin-bottom: 10px; cursor: pointer; transition: background 0.2s, border-color 0.2s;" title="Tap to edit hits">
                    <p style="margin-bottom: 5px; font-size: 0.9rem;">Hits to assign <span style="font-size: 0.8rem; opacity: 0.8;">(tap to edit)</span>:</p>
                    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                        ${remainingHits.map((h, idx) => `
                            <span style="
                                padding: 8px 15px;
                                border-radius: 8px;
                                font-weight: bold;
                                font-size: 1.2rem;
                                background: ${idx === 0 ? '#feca57' : 'rgba(255,255,255,0.2)'};
                                color: ${idx === 0 ? '#1a1a2e' : '#fff'};
                                ${idx === 0 ? 'box-shadow: 0 0 10px rgba(254,202,87,0.5);' : ''}
                            ">${h.roll}</span>
                        `).join('')}
                    </div>
                </div>
                ${state.attackLog.length > 0 ? `
                    <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 5px;">
                        ${state.attackLog.join('<br>')}
                    </div>
                ` : ''}
            `;

            document.getElementById('editable-hits-box').addEventListener('click', () => {
                if (!confirm('Edit hits? You\'ll change which rolls counted as hits and confirm again. Any damage already assigned will be undone.')) return;
                state.attackAssignments.forEach(({ playerId, roll }) => {
                    const p = state.players.find(pl => pl.id === playerId);
                    if (p) {
                        p.hp += roll;
                        if (p.hp > 0) p.eliminated = false;
                    }
                });
                state.damageClaimedPhase = false;
                state.currentHitIndex = 0;
                state.attackLog = [];
                state.attackAssignments = [];
                updatePlayersPanel();
                checkWinCondition();
                showHitRecorder(state.hits);
            });

            enableTargetSelection();
        }

        function enableTargetSelection() {
            const current = getCurrentPlayer();
            const cards = document.querySelectorAll('.player-card');

            cards.forEach(card => {
                const playerId = parseInt(card.dataset.player);
                const player = state.players.find(p => p.id === playerId);

                if (!player.eliminated && player.id !== current.id) {
                    card.classList.add('targetable');
                    card.addEventListener('click', handleAttack);
                }
            });
        }

        function disableTargetSelection() {
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('targetable');
                card.removeEventListener('click', handleAttack);
            });
        }

        function handleAttack(e) {
            const card = e.currentTarget;
            const playerId = parseInt(card.dataset.player);
            const targetPlayer = state.players.find(p => p.id === playerId);
            const currentPlayer = getCurrentPlayer();
            const currentHit = state.hits[state.currentHitIndex];

            disableTargetSelection();

            state.attackAssignments.push({ playerId: targetPlayer.id, roll: currentHit.roll });
            targetPlayer.hp = Math.max(0, targetPlayer.hp - currentHit.roll);
            state.hasScoreBeenEntered = true;
            currentPlayer.totalClaimed = (currentPlayer.totalClaimed || 0) + currentHit.roll;
            addLogEntry(`${currentPlayer.name} dealt ${currentHit.roll} damage to ${targetPlayer.name}!`, 'damage');
            state.attackLog.push(`${currentHit.roll} ‚Üí ${targetPlayer.name}`);

            if (targetPlayer.hp <= 0) {
                targetPlayer.eliminated = true;
                addLogEntry(`${targetPlayer.name} has been eliminated!`, 'info');
            }

            updatePlayersPanel();
            checkWinCondition();

            state.currentHitIndex++;

            if (state.phase === 'playing') {
                showNextHitToAssign();
            }
        }

        function finishAttackPhase() {
            const totalDealt = state.hits.reduce((sum, h) => sum + h.roll, 0);

            hitInfo.innerHTML = `
                <div style="background: rgba(255, 107, 107, 0.2); padding: 15px; border-radius: 10px; border: 2px solid #ff6b6b;">
                    <p style="font-size: 1.1rem; margin-bottom: 8px;">Attacks Complete!</p>
                    <div style="font-size: 0.9rem;">
                        ${state.attackLog.map(log => `<div>${log}</div>`).join('')}
                    </div>
                    <p style="margin-top: 8px;">Total Damage: <strong style="color: #ff6b6b;">${totalDealt}</strong></p>
                </div>
            `;
            attackPrompt.classList.add('hidden');
            endTurnBtn.classList.remove('hidden');
            state.hasAttacked = true;
        }

        function finishTurnNoAttack() {
            droppedKnifeBtn.classList.add('hidden');
            state.damageDealtThisTurn = true;
            hitInfo.innerHTML = `<span class="hit-badge miss">No damage this turn</span>`;
            attackPrompt.classList.add('hidden');
            endTurnBtn.classList.remove('hidden');
            state.hasAttacked = true;
        }

        droppedKnifeBtn.addEventListener('click', () => {
            const MAX_SCORES_PER_TURN = 3;
            if (state.hits.length + state.dropsThisTurn >= MAX_SCORES_PER_TURN) {
                return;
            }
            const current = getCurrentPlayer();
            current.hp = Math.max(0, current.hp - 1);
            state.hasScoreBeenEntered = true;
            state.dropsThisTurn++;
            addLogEntry(`${current.name} dropped a knife! (-1 HP)`, 'damage');
            state.lastDroppedKnifeLogIndex = state.gameLog.length - 1;
            if (!state.damageDealtThisTurn) state.dropsThisTurnLogIndices.push(state.gameLog.length - 1);
            updatePlayersPanel();
            const scoreCounter = hitInfo.querySelector('.scores-counter');
            if (scoreCounter) scoreCounter.textContent = `Scores: ${state.hits.length + state.dropsThisTurn} / ${MAX_SCORES_PER_TURN}`;

            requestAnimationFrame(() => {
                const card = document.querySelector(`.player-card[data-player="${current.id}"]`);
                if (card) {
                    card.classList.add('player-card-dropped');
                    setTimeout(() => card.classList.remove('player-card-dropped'), 600);
                }
            });

            if (current.hp <= 0) {
                current.eliminated = true;
                addLogEntry(`${current.name} has been eliminated!`, 'info');
                checkWinCondition();
                if (state.phase === 'playing') {
                    nextTurn();
                }
            }
        });

        const playerStatsModal = document.getElementById('player-stats-modal');
        const playerStatsTitle = document.getElementById('player-stats-title');
        const playerStatsAvatar = document.getElementById('player-stats-avatar');
        const playerStatsHp = document.getElementById('player-stats-hp');
        const playerStatsTurnOrder = document.getElementById('player-stats-turn-order');
        const playerStatsStatus = document.getElementById('player-stats-status');
        const playerStatsHitDrop = document.getElementById('player-stats-hit-drop');
        const playerStatsRolledClaimed = document.getElementById('player-stats-rolled-claimed');
        const playerStatsCritical = document.getElementById('player-stats-critical');
        const playerStatsDropsHint = document.getElementById('player-stats-drops-hint');
        const playerStatsUndoDropBtn = document.getElementById('player-stats-undo-drop-btn');
        const playerStatsCloseBtn = document.getElementById('player-stats-close-btn');

        let playerStatsModalPlayerId = null;

        function openPlayerStatsModal(playerId) {
            const player = state.players.find(p => p.id === playerId);
            if (!player) return;
            playerStatsModalPlayerId = playerId;
            playerStatsTitle.textContent = player.name;
            playerStatsAvatar.style.background = player.color.hex;
            playerStatsHp.textContent = `${player.hp} / ${player.maxHp} HP`;
            playerStatsTurnOrder.textContent = `Turn order: #${state.players.indexOf(player) + 1}`;
            if (player.eliminated) {
                playerStatsStatus.textContent = 'Status: Eliminated';
                playerStatsStatus.style.color = '#e74c3c';
            } else if (state.players[state.currentPlayerIndex].id === player.id) {
                playerStatsStatus.textContent = 'Status: Current turn';
                playerStatsStatus.style.color = '#feca57';
            } else {
                playerStatsStatus.textContent = 'Status: In game';
                playerStatsStatus.style.color = '#48dbfb';
            }

            const hitCount = state.gameLog.filter(e => e.message.includes(player.name) && e.message.includes('dealt') && e.message.includes('damage to')).length;
            const dropCountForStat = state.gameLog.filter(e => e.type === 'damage' && e.message.includes('dropped a knife') && e.message.includes(player.name)).length;
            const totalScoring = hitCount + dropCountForStat;
            if (totalScoring > 0) {
                const hitPct = (hitCount / totalScoring * 100).toFixed(1);
                playerStatsHitDrop.textContent = `Efficiency: ${hitPct}%`;
            } else {
                playerStatsHitDrop.textContent = 'Efficiency: ‚Äî';
            }

            const rolled = player.totalRolled || 0;
            const claimed = player.totalClaimed || 0;
            if (rolled > 0) {
                const pct = (claimed / rolled * 100).toFixed(1);
                playerStatsRolledClaimed.textContent = `Points: ${claimed}/${rolled} (${pct}%)`;
            } else {
                playerStatsRolledClaimed.textContent = 'Points: ‚Äî';
            }

            playerStatsCritical.textContent = `Criticals: ${player.criticals || 0}`;

            const current = getCurrentPlayer();
            const undoableCount = !state.damageDealtThisTurn && current.id === player.id ? state.dropsThisTurnLogIndices.length : 0;
            const canUndoDrop = undoableCount > 0;

            const dropCount = state.gameLog.filter(e => e.type === 'damage' && e.message.includes('dropped a knife') && e.message.includes(player.name)).length;
            playerStatsDropsHint.textContent = dropCount === 0 ? 'No drops this game.' : `${dropCount} drop(s) this game.`;
            playerStatsUndoDropBtn.style.display = canUndoDrop ? 'block' : 'none';
            playerStatsUndoDropBtn.textContent = undoableCount === 1 ? 'Undo last drop' : `Undo last drop (${undoableCount} undoable)`;
            playerStatsModal.classList.add('open');
        }

        function closePlayerStatsModal() {
            playerStatsModal.classList.remove('open');
            playerStatsModalPlayerId = null;
        }

        playerStatsCloseBtn.addEventListener('click', closePlayerStatsModal);
        playerStatsModal.addEventListener('click', (e) => { if (e.target === playerStatsModal) closePlayerStatsModal(); });

        playerStatsUndoDropBtn.addEventListener('click', () => {
            if (playerStatsModalPlayerId === null) return;
            const current = getCurrentPlayer();
            if (current.id !== playerStatsModalPlayerId) return;
            if (state.damageDealtThisTurn || state.dropsThisTurnLogIndices.length === 0) return;
            const logIndex = state.dropsThisTurnLogIndices.pop();
            const logEntry = state.gameLog[logIndex];
            if (!logEntry || logEntry.type !== 'damage' || !logEntry.message.includes('dropped a knife') || !logEntry.message.includes(current.name)) {
                state.dropsThisTurnLogIndices.push(logIndex);
                return;
            }
            const domIndex = state.gameLog.length - 1 - logIndex;
            if (gameLogEntries.children[domIndex]) gameLogEntries.children[domIndex].remove();
            state.gameLog.splice(logIndex, 1);
            for (let i = 0; i < state.dropsThisTurnLogIndices.length; i++) {
                if (state.dropsThisTurnLogIndices[i] > logIndex) state.dropsThisTurnLogIndices[i]--;
            }
            current.hp = Math.min(current.maxHp, current.hp + 1);
            if (current.hp > 0) current.eliminated = false;
            state.dropsThisTurn = Math.max(0, state.dropsThisTurn - 1);
            state.lastDroppedKnifeLogIndex = state.dropsThisTurnLogIndices.length > 0 ? state.dropsThisTurnLogIndices[state.dropsThisTurnLogIndices.length - 1] : undefined;
            updatePlayersPanel();
            checkWinCondition();
            const scoreCounter = hitInfo.querySelector('.scores-counter');
            if (scoreCounter) scoreCounter.textContent = `Scores: ${state.hits.length + state.dropsThisTurn} / 3`;
            openPlayerStatsModal(playerStatsModalPlayerId);
        });

        playersPanel.addEventListener('click', (e) => {
            const btn = e.target.closest('.player-card-stats-btn');
            if (!btn) return;
            e.stopPropagation();
            const playerId = parseInt(btn.dataset.player, 10);
            openPlayerStatsModal(playerId);
        });

        endTurnBtn.addEventListener('click', () => {
            nextTurn();
        });

        function nextTurn() {
            disableTargetSelection();
            state.lastDroppedKnifeLogIndex = undefined;
            state.dropsThisTurn = 0;
            state.dropsThisTurnLogIndices = [];
            state.damageDealtThisTurn = false;

            let nextIdx = state.currentPlayerIndex;
            const alivePlayers = getAlivePlayers();

            if (alivePlayers.length <= 1) {
                checkWinCondition();
                return;
            }

            do {
                nextIdx = (nextIdx + 1) % state.players.length;
            } while (state.players[nextIdx].eliminated);

            state.currentPlayerIndex = nextIdx;
            addLogEntry(`${getCurrentPlayer().name}'s turn begins.`, 'info');
            updateGameUI();
        }

        function checkWinCondition() {
            const alivePlayers = getAlivePlayers();
            if (alivePlayers.length === 1) {
                state.phase = 'finished';
                showWinner(alivePlayers[0]);
            } else if (alivePlayers.length === 0) {
                state.phase = 'finished';
                showWinner(null);
            }
        }

        function showWinner(winner) {
            gameScreen.style.display = 'none';
            winnerScreen.style.display = 'block';

            if (winner) {
                document.getElementById('winner-name').innerHTML = `
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: ${winner.color.hex}; margin: 0 auto 20px;"></div>
                    <span style="color: ${winner.color.hex};">${winner.name}</span> Wins!
                `;
            } else {
                document.getElementById('winner-name').textContent = "It's a Draw!";
            }
        }

        function generateGameReportHTML(winner) {
            const now = new Date();
            const dateStr = now.toLocaleDateString(undefined, { dateStyle: 'long' });
            const timeStr = now.toLocaleTimeString(undefined, { timeStyle: 'short' });
            const winnerText = winner ? winner.name : "Draw (no winner)";
            const turnOrderList = state.players.map((p, i) => `${i + 1}. ${p.name}`).join(', ');

            const playerRows = state.players.map(p => {
                let status = p.eliminated ? 'Eliminated' : (winner && p.id === winner.id ? 'Winner' : 'Survived');
                return `
                <tr>
                    <td><span class="report-color-dot" style="background:${p.color.hex}"></span> ${escapeHtml(p.name)}</td>
                    <td>${p.hp} / ${p.maxHp}</td>
                    <td><span class="report-status report-status-${status.toLowerCase().replace(/\s/g,'')}">${status}</span></td>
                </tr>`;
            }).join('');

            // Per-player stats for breakdown
            const playerStatsBreakdown = state.players.map(p => {
                const status = p.eliminated ? 'Eliminated' : (winner && p.id === winner.id ? 'Winner' : 'Survived');
                const hitCount = state.gameLog.filter(e => e.message.includes(p.name) && e.message.includes('dealt') && e.message.includes('damage to')).length;
                const dropCount = state.gameLog.filter(e => e.type === 'damage' && e.message.includes('dropped a knife') && e.message.includes(p.name)).length;
                const totalScoring = hitCount + dropCount;
                const efficiency = totalScoring > 0 ? (hitCount / totalScoring * 100).toFixed(1) : '‚Äî';
                const rolled = p.totalRolled || 0;
                const claimed = p.totalClaimed || 0;
                const pointsPct = rolled > 0 ? (claimed / rolled * 100).toFixed(1) : '‚Äî';
                const pointsStr = rolled > 0 ? `${claimed} / ${rolled} (${pointsPct}%)` : '‚Äî';
                return `
                <div class="report-player-card" style="border-left-color: ${p.color.hex}">
                    <h3 class="report-player-name"><span class="report-color-dot" style="background:${p.color.hex}"></span> ${escapeHtml(p.name)}</h3>
                    <table class="report-stats-table">
                        <tr><td>Status</td><td><span class="report-status report-status-${status.toLowerCase().replace(/\s/g,'')}">${status}</span></td></tr>
                        <tr><td>Final HP</td><td>${p.hp} / ${p.maxHp}</td></tr>
                        <tr><td>Hits dealt</td><td>${hitCount}</td></tr>
                        <tr><td>Drops (self-damage)</td><td>${dropCount}</td></tr>
                        <tr><td>Criticals</td><td>${p.criticals || 0}</td></tr>
                        <tr><td>Efficiency</td><td>${efficiency}${efficiency !== '‚Äî' ? '%' : ''}</td></tr>
                        <tr><td>Points (claimed / rolled)</td><td>${pointsStr}</td></tr>
                    </table>
                </div>`;
            }).join('');

            const logEntries = state.gameLog.map((e, i) => {
                const cls = e.type === 'damage' ? 'report-log-damage' : e.type === 'heal' ? 'report-log-heal' : 'report-log-info';
                return `<li class="report-log-entry ${cls}"><span class="report-log-num">${i + 1}.</span> ${escapeHtml(e.message)}</li>`;
            }).join('');
            const totalActions = state.gameLog.length;

            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dagger &amp; Die - Game Report</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            padding: 40px 20px;
            line-height: 1.5;
        }
        .report-container { max-width: 720px; margin: 0 auto; }
        .report-header {
            text-align: center;
            margin-bottom: 36px;
            padding-bottom: 24px;
            border-bottom: 2px solid rgba(255,255,255,0.15);
        }
        .report-title {
            font-size: 2rem;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        .report-meta { color: rgba(255,255,255,0.6); font-size: 0.95rem; }
        .report-winner-box {
            background: rgba(254, 202, 87, 0.15);
            border: 2px solid rgba(254, 202, 87, 0.5);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 28px;
            text-align: center;
        }
        .report-winner-label { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; color: rgba(255,255,255,0.7); margin-bottom: 4px; }
        .report-winner-name { font-size: 1.5rem; font-weight: bold; color: #feca57; }
        .report-section {
            background: rgba(0,0,0,0.25);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }
        .report-section h2 {
            font-size: 1.1rem;
            color: #48dbfb;
            margin-bottom: 14px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .report-table { width: 100%; border-collapse: collapse; }
        .report-table th, .report-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .report-table th { color: rgba(255,255,255,0.7); font-weight: 600; font-size: 0.85rem; }
        .report-color-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; vertical-align: middle; margin-right: 6px; }
        .report-status { font-size: 0.85rem; padding: 2px 8px; border-radius: 6px; }
        .report-status-winner { background: rgba(46, 204, 113, 0.3); color: #2ecc71; }
        .report-status-eliminated { background: rgba(231, 76, 60, 0.3); color: #e74c3c; }
        .report-status-survived { background: rgba(72, 219, 251, 0.2); color: #48dbfb; }
        .report-turn-order { color: rgba(255,255,255,0.85); font-size: 0.95rem; }
        .report-log { list-style: none; }
        .report-log-entry { padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 0.9rem; display: flex; gap: 8px; }
        .report-log-entry:last-child { border-bottom: none; }
        .report-log-num { color: rgba(255,255,255,0.4); min-width: 28px; }
        .report-log-damage { color: #ff6b6b; }
        .report-log-heal { color: #2ecc71; }
        .report-log-info { color: #48dbfb; }
        .report-player-card {
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 16px;
            border-left: 4px solid #48dbfb;
        }
        .report-player-card:last-child { margin-bottom: 0; }
        .report-player-name { font-size: 1rem; color: #e8e8e8; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .report-stats-table { width: 100%; font-size: 0.9rem; }
        .report-stats-table td { padding: 4px 0; border: none; }
        .report-stats-table td:first-child { color: rgba(255,255,255,0.6); width: 55%; }
        .report-stats-table td:last-child { color: #e8e8e8; }
    </style>
</head>
<body>
    <div class="report-container">
        <header class="report-header">
            <h1 class="report-title">Dagger &amp; Die</h1>
            <p class="report-meta">Game Report &middot; ${escapeHtml(dateStr)} at ${escapeHtml(timeStr)}</p>
        </header>
        <div class="report-winner-box">
            <div class="report-winner-label">Winner</div>
            <div class="report-winner-name">${escapeHtml(winnerText)}</div>
        </div>
        <section class="report-section">
            <h2>Players (final)</h2>
            <table class="report-table">
                <thead><tr><th>Player</th><th>HP</th><th>Status</th></tr></thead>
                <tbody>${playerRows}</tbody>
            </table>
        </section>
        <section class="report-section">
            <h2>Turn order</h2>
            <p class="report-turn-order">${escapeHtml(turnOrderList)}</p>
        </section>
        <section class="report-section">
            <h2>Player stats breakdown</h2>
            <div class="report-player-cards">${playerStatsBreakdown}</div>
        </section>
        <section class="report-section">
            <h2>Game ledger (${totalActions} entries)</h2>
            <ul class="report-log">${logEntries || '<li class="report-log-info">No actions recorded.</li>'}</ul>
        </section>
    </div>
</body>
</html>`;
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function exportGameReport() {
            const winner = getAlivePlayers().length === 1 ? getAlivePlayers()[0] : null;
            const html = generateGameReportHTML(winner);
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank', 'noopener');
            const a = document.createElement('a');
            a.href = url;
            a.download = `dagger-die-report-${new Date().toISOString().slice(0,10)}.html`;
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 2000);
        }

        document.getElementById('export-report-btn').addEventListener('click', exportGameReport);

        function resetDice() {
            ['die1', 'die2', 'die3'].forEach(id => {
                const die = document.getElementById(id);
                die.textContent = '-';
                die.classList.remove('odd', 'even', 'rolling');
            });
        }

        function addLogEntry(message, type = 'info') {
            state.gameLog.push({ message, type });
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            gameLogEntries.insertBefore(entry, gameLogEntries.firstChild);
        }

        function showCriticalReaction(playerName) {
            const el = document.getElementById('critical-reaction');
            if (!el) return;
            const inner = el.querySelector('.critical-reaction-inner');
            if (inner) inner.textContent = 'Critical!';
            el.classList.remove('hide');
            el.classList.add('show');
            setTimeout(() => {
                el.classList.remove('show');
                el.classList.add('hide');
                setTimeout(() => el.classList.remove('hide'), 300);
            }, 1000);
        }

        document.getElementById('new-game-btn').addEventListener('click', resetGame);
                function playAgain() {
            const defaultHp = getDefaultHp(state.players.length);
            state.players.forEach(p => {
                p.hp = defaultHp;
                p.maxHp = defaultHp;
                p.eliminated = false;
                p.turnOrderRoll = 0;
                p.totalRolled = 0;
                p.totalClaimed = 0;
                p.criticals = 0;
            });
            state.currentPlayerIndex = 0;
            state.phase = 'turnOrder';
            state.currentRoll = [];
            state.hits = [];
            state.totalDamage = 0;
            state.hasRolled = false;
            state.hasAttacked = false;
            state.damageClaimedPhase = false;
            state.currentHitIndex = 0;
            state.attackLog = [];
            state.gameLog = [];
            state.hasScoreBeenEntered = false;
            state.lastDroppedKnifeLogIndex = undefined;
            state.dropsThisTurn = 0;
            state.dropsThisTurnLogIndices = [];
            state.damageDealtThisTurn = false;

            winnerScreen.style.display = 'none';
            gameScreen.style.display = 'none';
            turnOrderScreen.style.display = 'block';

            const rollBtn = document.getElementById('roll-turn-order-btn');
            rollBtn.classList.remove('hidden');
            rollBtn.disabled = false;
            document.getElementById('begin-game-btn').classList.add('hidden');

            const rollsDiv = document.getElementById('turn-order-rolls');
            rollsDiv.innerHTML = state.players.map(p => `
                <div class="turn-order-player" data-player="${p.id}">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; border-radius: 50%; background: ${p.color.hex};"></div>
                        <span>${p.name}</span>
                    </div>
                    <span class="roll-value">-</span>
                </div>
            `).join('');

            const tieMsg = document.getElementById('tie-reroll-message');
            if (tieMsg) tieMsg.style.display = 'none';

            gameLogEntries.innerHTML = '';
        }

        document.getElementById('play-again-btn').addEventListener('click', playAgain);
        document.getElementById('finished-btn').addEventListener('click', () => { window.location.href = 'index.html'; });

        function resetGame() {
            state.players = [];
            state.currentPlayerIndex = 0;
            state.phase = 'setup';
            state.currentRoll = [];
            state.hits = [];
            state.totalDamage = 0;
            state.hasRolled = false;
            state.hasAttacked = false;
            state.damageClaimedPhase = false;
            state.currentHitIndex = 0;
            state.attackLog = [];
            state.gameLog = [];
            state.hasScoreBeenEntered = false;
            state.lastDroppedKnifeLogIndex = undefined;
            state.dropsThisTurn = 0;
            state.dropsThisTurnLogIndices = [];
            state.damageDealtThisTurn = false;

            gameScreen.style.display = 'none';
            winnerScreen.style.display = 'none';
            turnOrderScreen.style.display = 'none';
            setupScreen.style.display = 'block';

            document.querySelectorAll('.player-count-btn').forEach(b => b.classList.remove('selected'));
            playerSetup.innerHTML = '';
            playerSetup.classList.remove('visible');
            startGameBtn.style.display = 'none';
            const setupError = document.getElementById('setup-error');
            if (setupError) {
                setupError.classList.add('hidden');
                setupError.textContent = '';
            }
            gameLogEntries.innerHTML = '';

            document.getElementById('roll-turn-order-btn').classList.remove('hidden');
            document.getElementById('roll-turn-order-btn').disabled = false;
            document.getElementById('begin-game-btn').classList.add('hidden');
        }
    </script>
</body>
</html>
