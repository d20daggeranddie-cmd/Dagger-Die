<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dagger & Die - Projector</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%;
            height: 100%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .target-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 64px;
        }
        .target-face {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
        }

        /* ── D20 face styling (from resources/d20_blank) ── */
        .highlight-zone .face-shape {
            fill: #2a1f3d;
            stroke: #8a7fa8;
            stroke-width: 1.5;
            stroke-linejoin: round;
            transition: fill 0.3s ease, stroke 0.3s ease, filter 0.3s ease;
        }
        .highlight-zone .face-shape.d20-face-center {
            fill: #3d2a5c;
        }
        .highlight-zone .face-shape.d20-face-outer {
            fill: #1e1630;
        }

        /* ── Rolled (active) state — gold glow ── */
        .highlight-zone.active .face-shape {
            fill: #ffd700;
            stroke: #b8960f;
            stroke-width: 2;
            filter: url(#glow-gold);
        }

        /* ── Claimed (hit) state — green glow ── */
        .highlight-zone.claimed .face-shape {
            fill: #2ecc71;
            stroke: #1a9c54;
            stroke-width: 2;
            filter: url(#glow-green);
        }

        /* ── Pulse animation for active zones ── */
        .highlight-zone.active .face-shape {
            animation: projectorPulse 1.5s ease-in-out infinite;
        }
        .highlight-zone.claimed .face-shape {
            animation: none;
        }
        @keyframes projectorPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ── Connection status indicator ── */
        .status-dot {
            position: fixed;
            top: 12px;
            right: 12px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ccc;
            border: 2px solid #999;
            transition: all 0.3s;
            z-index: 100;
        }
        .status-dot.connected {
            background: #2ecc71;
            border-color: #1a9c54;
            box-shadow: 0 0 8px rgba(46, 204, 113, 0.5);
        }
        .status-dot.active {
            background: #ffd700;
            border-color: #b8960f;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
        }

        .m3-logo {
            position: fixed; bottom: 10px; right: 10px; z-index: 50;
            width: 36px; height: auto; pointer-events: none;
        }
        @media (max-width: 480px) { .m3-logo { width: 28px; bottom: 8px; right: 8px; } }
    </style>
</head>
<body>
    <img src="assets/m3.png" alt="M3" class="m3-logo">
    <div class="status-dot" id="status-dot" title="Waiting for game connection..."></div>

    <div class="target-wrapper">
        <svg class="target-face" id="target-board" viewBox="0 0 400 460" preserveAspectRatio="xMidYMid meet" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <filter id="glow-gold" x="-20%" y="-20%" width="140%" height="140%">
                    <feGaussianBlur stdDeviation="3" result="blur"/>
                    <feFlood flood-color="#ffd700" flood-opacity="0.5" result="color"/>
                    <feComposite in="color" in2="blur" operator="in" result="shadow"/>
                    <feMerge><feMergeNode in="shadow"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
                <filter id="glow-green" x="-20%" y="-20%" width="140%" height="140%">
                    <feGaussianBlur stdDeviation="3" result="blur"/>
                    <feFlood flood-color="#2ecc71" flood-opacity="0.5" result="color"/>
                    <feComposite in="color" in2="blur" operator="in" result="shadow"/>
                    <feMerge><feMergeNode in="shadow"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
            </defs>

            <!-- D20 faces from resources/d20_blank.html -->
            <g id="face-tl" class="highlight-zone" data-pair="10-17">
                <polygon class="face-shape d20-face" points="200,2 7,119 200,59"/>
            </g>
            <g id="face-tr" class="highlight-zone" data-pair="11-20">
                <polygon class="face-shape d20-face" points="200,2 200,59 393,119"/>
            </g>
            <g id="face-l" class="highlight-zone" data-pair="3-4">
                <polygon class="face-shape d20-face" points="7,119 66,316 200,59"/>
            </g>
            <g id="face-r" class="highlight-zone" data-pair="6-7">
                <polygon class="face-shape d20-face" points="200,59 334,316 393,119"/>
            </g>
            <g id="face-fl" class="highlight-zone" data-pair="12-15">
                <polygon class="face-shape d20-face-outer" points="7,119 2,346 66,316"/>
            </g>
            <g id="face-fr" class="highlight-zone" data-pair="9-14">
                <polygon class="face-shape d20-face-outer" points="393,119 334,316 398,346"/>
            </g>
            <g id="face-bl" class="highlight-zone" data-pair="13-18">
                <polygon class="face-shape d20-face-outer" points="66,316 2,346 200,458"/>
            </g>
            <g id="face-br" class="highlight-zone" data-pair="16-19">
                <polygon class="face-shape d20-face-outer" points="334,316 200,458 398,346"/>
            </g>
            <g id="face-bc" class="highlight-zone" data-pair="5-8">
                <polygon class="face-shape d20-face" points="66,316 200,458 334,316"/>
            </g>
            <g id="face-center" class="highlight-zone" data-pair="1-2">
                <polygon class="face-shape d20-face-center" points="200,59 66,316 334,316"/>
            </g>
        </svg>
    </div>

    <script>
    (function() {
        // ── Number-to-pair lookup ──
        // Each d20 number maps to its face's data-pair attribute
        const numberToPair = {
            1: '1-2',    2: '1-2',
            3: '3-4',    4: '3-4',
            5: '5-8',    8: '5-8',
            6: '6-7',    7: '6-7',
            9: '9-14',  14: '9-14',
           10: '10-17', 17: '10-17',
           11: '11-20', 20: '11-20',
           12: '12-15', 15: '12-15',
           13: '13-18', 18: '13-18',
           16: '16-19', 19: '16-19'
        };

        const allZones = document.querySelectorAll('.highlight-zone');
        const statusDot = document.getElementById('status-dot');

        function clearAll() {
            allZones.forEach(z => {
                z.classList.remove('active', 'claimed');
            });
        }

        function highlightRolls(rolls) {
            // Collect unique pairs that were rolled
            const activePairs = new Set();
            rolls.forEach(r => {
                const pair = numberToPair[r];
                if (pair) activePairs.add(pair);
            });
            allZones.forEach(z => {
                const pair = z.getAttribute('data-pair');
                if (activePairs.has(pair)) {
                    z.classList.add('active');
                } else {
                    z.classList.remove('active');
                }
            });
        }

        function highlightClaimed(claimed) {
            const claimedPairs = new Set();
            claimed.forEach(r => {
                const pair = numberToPair[r];
                if (pair) claimedPairs.add(pair);
            });
            allZones.forEach(z => {
                const pair = z.getAttribute('data-pair');
                if (claimedPairs.has(pair)) {
                    z.classList.add('claimed');
                    z.classList.remove('active');
                } else {
                    z.classList.remove('claimed');
                }
            });
        }

        // ── BroadcastChannel listener ──
        const channel = new BroadcastChannel('daggerdie-projector');

        channel.onmessage = function(event) {
            const msg = event.data;

            // Flash status dot on any message
            statusDot.classList.add('connected');

            if (msg.type === 'clear') {
                clearAll();
                statusDot.classList.remove('active');
                return;
            }

            if (msg.type === 'roll') {
                clearAll();
                highlightRolls(msg.rolls || []);
                statusDot.classList.add('active');
                return;
            }

            if (msg.type === 'update') {
                // Full state update: rolls + claimed
                clearAll();
                highlightRolls(msg.rolls || []);
                highlightClaimed(msg.claimed || []);
                statusDot.classList.add('active');
                return;
            }
        };
    })();
    </script>
</body>
</html>
